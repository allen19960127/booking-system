<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>謎失工作室 排程同步系統（V53 修正預約後自動顯示已過時間問題）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    /* 樣式部分完全採用 V13/V50/V52 原始樣式 */
    body { font-family: 'Noto Sans TC', sans-serif; background:#f0f4f8; color:#2c3e50; padding:20px; margin:0; line-height:1.6; padding-bottom: 100px; }
    h1 { text-align:center; margin:20px 0 10px; font-size:2.2em; color:#34495e; }
    #auth-container { text-align:center; margin-bottom:25px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    #user-status { margin:5px 0 15px; font-size:1.1em; color:#2980b9; font-weight:500; }
    #status-message { text-align:center; margin-bottom:20px; padding:12px; border-radius:8px; color:white; font-weight:bold; font-size: 1.1em; display: flex; justify-content: center; align-items: center; gap: 15px; }
    #top-controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; gap: 15px; }
    #date-picker-container { display: flex; gap: 10px; align-items: center; font-weight: 500; font-size: 1.1em; padding: 10px 0; }
    .container { display:flex; flex-wrap:wrap; justify-content:center; gap:25px; }
    .theme { background:#fff; padding:20px; border-radius:12px; width:100%; max-width:650px; box-shadow:0 6px 15px rgba(0,0,0,0.1); border-top:5px solid #3498db; }
    .theme h2 { text-align:center; background:#ecf0f1; padding:12px; border-radius:8px; margin:0 0 20px; font-size:1.5em; color:#34495e; }
    .slots { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; }
    .slot { padding:10px 5px; text-align:center; border-radius:6px; font-weight:500; font-size:0.9em; user-select:none; line-height:1.2; transition:all 0.15s; cursor:default; }
    .available { background:#2ecc71; color:white; cursor:pointer; }
    .available:hover { background:#27ae60; transform:translateY(-1px); }
    .booked { background:#e74c3c; color:white; cursor:pointer; }
    .booked:hover { background:#c0392b; transform:translateY(-1px); }
    .blocked { background:#bdc3c7; color:#7f8c8d; cursor:not-allowed; opacity:0.8; }
    .lobby-clash { background:#9b59b6; color:white; cursor:not-allowed; }
    .external-booked { background:#f39c12; color:white; font-weight:700; cursor:not-allowed; }
    .past-time { background:#a0a0a0; color:white; cursor:not-allowed; opacity:0.6; } 
    .hidden-past { display: none !important; }
    .available-slots-area { margin-top:25px; padding:15px; background:#f8f9fa; border-radius:8px; }
    .available-slots-area strong { display:block; margin-bottom:8px; color:#e67e22; font-weight:700; }
    .copy-button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
    .copy-button:hover { background:#2980b9; }
    #controls { position:fixed; bottom:20px; right:20px; display:flex; gap:10px; z-index:999; }
    #controls button { padding:12px 20px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    #clear-manual { background:#95a5a6; } 
    #hide-past-btn { background:#bdc3c7; } 
    #hide-past-btn.active { background:#3498db; }
    #copy-all { background:#8e44ad; }
    #filter-controls { text-align:center; font-weight:500; font-size:1.1em; color:#34495e; display: flex; justify-content: center; gap: 15px; }
    #filter-controls button { padding:10px 18px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    #override { background:#ff9f43; } 
    #override.active { background:#c0392b; }
    #clear { background:#e74c3c; }
</style>
</head>
<body>
<h1>謎失工作室 排程同步系統</h1>

<div id="auth-container">
    <p id="user-status">載入中...</p>
    <div id="google-signin-button"></div>
</div>
<div id="status-message" style="background:#bdc3c7;">載入中...</div>

<div id="top-controls">
    <div id="date-picker-container">
        查詢日期：
        <input type="date" id="calendar-date" onchange="render(true)" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
    </div>
    <div id="absence-alert"></div> 
</div>

<div id="filter-controls">
    <button id="override" onclick="toggleOverrideMode()">開放模式</button>
    <button id="clear" onclick="clearAll()">登出重製</button>
</div>

<div class="container">
    <div class="theme"><h2>301號房</h2><div class="slots" id="s1"></div><div id="remaining-301號房" class="available-slots-area"></div></div>
    <div class="theme"><h2>失物招領</h2><div class="slots" id="s2"></div><div id="remaining-失物招領" class="available-slots-area"></div></div>
    <div class="theme"><h2>藝樣的代價</h2><div class="slots" id="s3"></div><div id="remaining-藝樣的代價" class="available-slots-area"></div></div>
    <div class="theme"><h2>朱砂</h2><div class="slots" id="s4"></div><div id="remaining-朱砂" class="available-slots-area"></div></div>
</div>

<div id="controls">
    <button id="clear-manual" onclick="clearManualBookings()">取消手動</button>
    <button id="hide-past-btn" onclick="toggleHidePastSlots()">隱藏已過時間 (開)</button>
    <button id="copy-all" onclick="copyAllAvailableSlots()">全部複製</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ================== 設定區 ==================
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
const ABSENCE_KEYWORDS = ["邱不在", "鈺晴不在"]; 
const ABSENCE_CALENDAR_ID = '0aee774d72e9f3b5eb1098f54c2285dadd336dfa0b8b265be09f46a94a3644a4@group.calendar.google.com';
const PRIMARY_CALENDAR_ID = 'primary'; 

let localStorageKey = "mishi2025_final";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
let externalBookings = {};
let hidePastSlots = localStorage.getItem('hidePastSlots') !== 'false'; 
let overrideMode = false;
let selectedDate = new Date(); 

const CONFIG = {
    "301號房":      { dur: 90,  group: "館A", interval: 15, block_before: 0, block_after: 0, id: "s1", store: "山子頂店" },
    "失物招領":    { dur: 90,  group: "館A", interval: 15, block_before: 0, block_after: 0, id: "s2", store: "山子頂店" },
    "藝樣的代價": { dur: 150, group: "館B", interval: 30, block_before: 0, block_after: 0, id: "s3", store: "中壢店" },
    "朱砂":        { dur: 150, group: "館B", interval: 30, block_before: 0, block_after: 0, id: "s4", store: "中壢店" }
};

const tm = t => parseInt(t.split(":")[0])*60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(Math.floor(v%60)).padStart(2,'0')}`; 
const getCurrentMinutes = () => {
    const today = new Date();
    if (selectedDate.toDateString() !== today.toDateString()) return -1; 
    return today.getHours() * 60 + today.getMinutes();
}
const formatDate = (date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}
function generateTimes(interval) {
    let res = [];
    for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); 
    return res;
}

function initGoogleSignIn() {
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse, auto_select: false });
    google.accounts.id.renderButton(document.getElementById("google-signin-button"), { theme: "outline", size: "large" });
    document.getElementById('user-status').innerHTML = '請點下方按鈕登入 Google 以同步日曆';
    document.getElementById('calendar-date').value = formatDate(selectedDate);
}

function handleCredentialResponse(response) {
    google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPE, callback: (resp) => {
            if (resp.error) { alert("登入失敗：" + resp.error); return; }
            sessionStorage.setItem('google_access_token', resp.access_token);
            document.getElementById('user-status').innerHTML = '已登入，正在讀取日曆...';
            document.getElementById('google-signin-button').style.display = 'none';
            render(true);
        }
    }).requestAccessToken();
}

async function fetchCalendarBookings() {
    const token = sessionStorage.getItem('google_access_token');
    const statusEl = document.getElementById('status-message');
    if (!token) return {};
    const dateInput = document.getElementById('calendar-date').value;
    const dateParts = dateInput.split('-');
    selectedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
    const timeMin = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()).toISOString();
    const timeMax = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()+1).toISOString();
    statusEl.innerHTML = `正在讀取 ${dateInput} 的 Google 日曆...`; 
    statusEl.style.backgroundColor = '#3498db';
    const calendarIds = [PRIMARY_CALENDAR_ID, ABSENCE_CALENDAR_ID];
    const ext = {}; Object.keys(CONFIG).forEach(k => ext[k] = []);
    const absentStaff = new Set(); 
    try {
        for (const calId of calendarIds) {
            const res = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`, { headers: { Authorization: `Bearer ${token}` } });
            if (!res.ok) continue;
            const data = await res.json();
            data.items.forEach(item => {
                if (!item.summary) return;
                ABSENCE_KEYWORDS.forEach(keyword => { if (item.summary.includes(keyword)) absentStaff.add(keyword.replace('不在', '')); });
                if (item.start?.dateTime) {
                    const start = new Date(item.start.dateTime);
                    const timeStr = `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')}`;
                    Object.keys(CONFIG).forEach(theme => { if (item.summary.includes(theme)) ext[theme].push(timeStr); });
                }
            });
        }
        let statusMessage = '日曆同步完成！';
        if (absentStaff.size > 0) statusMessage += ` ⚠️ **${Array.from(absentStaff).join(' 和 ')} 不在場**`;
        statusEl.innerHTML = statusMessage; statusEl.style.backgroundColor = '#2ecc71';
        return ext;
    } catch (err) { statusEl.innerHTML = `日曆讀取失敗：${err.message}`; statusEl.style.backgroundColor = '#e74c3c'; return {}; }
}

function calculateSlotStatus(theme, timeStr) {
    const cfg = CONFIG[theme]; const cur = tm(timeStr); const dur = cfg.dur;
    if (localBookings[theme]?.includes(timeStr)) return 'booked';
    let isBlocked = false; let isLobbyClash = false;
    const allBookings = {};
    Object.keys(CONFIG).forEach(k => {
        allBookings[k] = localBookings[k] || [];
        if (!overrideMode) allBookings[k] = allBookings[k].concat(externalBookings[k] || []);
    });
    if (!overrideMode && externalBookings[theme]?.includes(timeStr)) return 'external-booked';
    Object.keys(CONFIG).forEach(otherTheme => {
        const otherConfig = CONFIG[otherTheme];
        allBookings[otherTheme].forEach(bookedTimeStr => {
            const bookedTime = tm(bookedTimeStr);
            if (cfg.group === otherConfig.group && theme !== otherTheme && cur === bookedTime) isLobbyClash = true;
            if (theme === otherTheme) {
                const lockStartTime = bookedTime - otherConfig.block_before;
                const lockEndTime = bookedTime + otherConfig.dur + otherConfig.block_after;
                const overlap = Math.max(0, Math.min(cur + dur, lockEndTime) - Math.max(cur, lockStartTime));
                if (overlap > 0) isBlocked = true;
            }
        });
    });
    if (isLobbyClash) return 'lobby-clash'; if (isBlocked) return 'blocked';
    return 'available';
}

// V53 修正：操作後呼叫渲染時傳入 true，確保檢查現在時間，不會跳回顯示已過時間
function handleSlotInteraction(theme, time, el) {
    const status = calculateSlotStatus(theme, time);
    if (localBookings[theme]?.includes(time)) {
        if (confirm(`確定要取消 ${theme} - ${time} 的手動預約嗎？`)) {
            localBookings[theme] = localBookings[theme].filter(t => t !== time);
            localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
            renderSlots(true); 
            updateRemainingSlotsDisplay();
        }
        return;
    }
    if (status === 'available') {
        localBookings[theme].push(time);
        localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
        renderSlots(true); 
        updateRemainingSlotsDisplay();
        return;
    }
    if (confirm(`您正選取當前無法預約的時間 ${time}，確定要強制預約嗎?`)) {
        if (!localBookings[theme].includes(time)) {
            localBookings[theme].push(time);
            localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
        }
        renderSlots(true); 
        updateRemainingSlotsDisplay();
    }
}

function renderSlots(doPastTimeCheck = true) {
    const currentMinutes = doPastTimeCheck ? getCurrentMinutes() : -1;
    const hidePastButton = document.getElementById('hide-past-btn');
    hidePastButton.className = hidePastSlots ? 'active' : '';
    hidePastButton.innerHTML = hidePastSlots ? '隱藏已過時間 (開)' : '顯示已過時間 (關)';
    Object.keys(CONFIG).forEach(theme => {
        const {id, interval} = CONFIG[theme]; const times = generateTimes(interval);
        let html = '';
        times.forEach(t => {
            const isPast = currentMinutes !== -1 && tm(t) < currentMinutes;
            let status = calculateSlotStatus(theme, t);
            let label = t; let slotClass = status;
            if (!overrideMode && isPast) { 
                if (status !== 'booked') slotClass = 'past-time';
                if (hidePastSlots) slotClass += ' hidden-past';
            }
            if (!overrideMode || status !== 'available') {
                if (status === 'blocked') label += '<br>(佔用)';
                else if (status === 'lobby-clash') label += '<br>(衝突)';
                else if (status === 'external-booked') label += '<br>(日曆已訂)';
            }
            html += `<div class="slot ${slotClass}" onclick="handleSlotInteraction('${theme}','${t}',this)" oncontextmenu="event.preventDefault(); handleSlotInteraction('${theme}','${t}',this)">${label}</div>`;
        });
        document.getElementById(id).innerHTML = html;
    });
    updateRemainingSlotsDisplay();
}

function toggleHidePastSlots() { hidePastSlots = !hidePastSlots; localStorage.setItem('hidePastSlots', hidePastSlots); renderSlots(true); }

function toggleOverrideMode() {
    overrideMode = !overrideMode; const btn = document.getElementById('override');
    btn.className = overrideMode ? 'active' : ''; btn.innerHTML = overrideMode ? 'Override 模式 (開)' : '開放模式';
    document.getElementById('status-message').style.backgroundColor = overrideMode ? '#c0392b' : '#2ecc71';
    renderSlots(true); 
}

function clearManualBookings() { if (confirm("確定要取消所有【手動預約】 (紅色)？")) { Object.keys(CONFIG).forEach(k => localBookings[k] = []); localStorage.setItem(localStorageKey, JSON.stringify(localBookings)); location.reload(); } }

function updateRemainingSlotsDisplay() {
    Object.keys(CONFIG).forEach(theme => {
        const area = document.getElementById(`remaining-${theme}`);
        const avail = generateTimes(CONFIG[theme].interval).filter(t => {
            const isPast = getCurrentMinutes() !== -1 && tm(t) < getCurrentMinutes();
            const status = calculateSlotStatus(theme, t);
            return overrideMode ? (status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash') : (!isPast && status === 'available');
        });
        const full = `${theme}: ${avail.join(', ')}`;
        area.innerHTML = `<strong>${theme} 可預約 (${avail.length}檔)${overrideMode ? ' [Override]' : ''}：</strong><div style="margin:8px 0; word-break:break-all;">${avail.length ? avail.join(', ') : '無空檔'}</div><button class="copy-button" onclick="navigator.clipboard.writeText('${full}').then(()=>alert('已複製！'))">複製本欄</button>`;
    });
}

function copyAllAvailableSlots() {
    let outputText = `【${formatDate(selectedDate)} 剩餘場次】\n\n`;
    ["中壢店", "山子頂店"].forEach(store => {
        outputText += `${store}\n`;
        Object.keys(CONFIG).filter(t => CONFIG[t].store === store).forEach(theme => {
            const avail = generateTimes(CONFIG[theme].interval).filter(t => {
                const isPast = getCurrentMinutes() !== -1 && tm(t) < getCurrentMinutes();
                const status = calculateSlotStatus(theme, t);
                return overrideMode ? (status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash') : (!isPast && status === 'available');
            });
            outputText += `${theme}: ${avail.length ? avail.join(', ') : '無空檔'}\n`;
        });
        outputText += "\n";
    });
    navigator.clipboard.writeText(outputText.trim()).then(() => alert('已複製全部！'));
}

async function render(doFetch = true) { if (doFetch) externalBookings = await fetchCalendarBookings(); renderSlots(true); }

function clearAll() { sessionStorage.clear(); localStorage.removeItem(localStorageKey); localStorage.removeItem('hidePastSlots'); location.reload(); }

window.onload = () => {
    Object.keys(CONFIG).forEach(k => { if (!localBookings[k]) localBookings[k] = []; });
    initGoogleSignIn();
    if (sessionStorage.getItem('google_access_token')) render(true); 
    else render(false);

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js').then(() => console.log('Service Worker 已註冊'));
    }
};
</script>
</body>
</html>