<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ å…§éƒ¨æ™‚é–“è¡¨ v14.0 (æ•´åˆ Google ç™»å…¥)</title>
<style>
  /* æ¨£å¼å€å¡Šèˆ‡ v13.0 ä¿æŒä¸€è‡´ï¼Œåƒ…æ–°å¢ç™»å…¥ç›¸é—œæ¨£å¼ */
  body{font-family:"Microsoft JhengHei",sans-serif;background:#2c3e50;color:#fff;padding:20px;margin:0;}
  h1{text-align:center;margin:30px 0 10px 0;font-size:2em;}
  #status-message {
    text-align: center; 
    margin-bottom: 20px; 
    font-weight: bold; 
    padding: 10px;
    border-radius: 8px;
  }
  #status-message a { font-weight: bold; }
  
  #auth-container { text-align: center; margin-bottom: 20px; padding: 10px; }
  #user-status { margin: 5px 0; font-size: 1.1em; }
  #google-signin-button { display: inline-block; } /* ç¢ºä¿æŒ‰éˆ•å±…ä¸­ */
  
  .container {display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;}
  .theme{background:#34495e;padding:20px;border-radius:15px;width:100%;max-width:650px; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
  .theme h2{text-align:center;background:#2c3e50;padding:12px;border-radius:10px;margin:0 0 15px 0;}
  .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;}
  
  .slot{padding:12px 5px;text-align:center;border-radius:10px;font-weight:bold;font-size:0.9em;transition:all 0.15s;user-select:none; position: relative;}
  
  .available{background:#27ae60;cursor:pointer;border: 2px solid #2ecc71;}
  .booked{background:#e74c3c;cursor:pointer;border: 2px solid #c0392b;}
  .blocked{ background:#566573; color:#bdc3c7; cursor:not-allowed; opacity:0.6; font-size: 0.8em; line-height: 1.1; border: 2px solid #4a545e; }
  .lobby-clash{background:#9b59b6; color: white;} 
  .external-booked{background:#f39c12; color: white; cursor:not-allowed; border: 2px solid #e67e22; opacity: 1.0;}

  .available-slots-area { margin-top: 20px; padding: 10px 0; border-top: 1px dashed #4a545e; display: flex; justify-content: space-between; align-items: flex-start; }
  .available-slots-area strong { display: block; margin-bottom: 5px; color: #f1c40f; flex-shrink: 0; }
  .copy-button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: background 0.2s; flex-shrink: 0; margin-left: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .copy-button:hover {background: #2980b9;}

  #controls {position:fixed;bottom:20px;right:20px;display: flex; gap: 10px; z-index:999;}
  button {border:none; padding:15px 25px; border-radius:50px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
  #clear{background:#e67e22;color:white;}
  #refresh{background:#3498db;color:white;}
  
  .legend {text-align: center; margin-bottom: 20px; font-size: 0.9em; display: flex; justify-content: center; gap: 15px;}
  .dot {display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px;}
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ å…§éƒ¨æ™‚é–“è¡¨ v14.0 (æ•´åˆ Google ç™»å…¥)</h1>

<div id="auth-container">
    <p id="user-status" style="color: #f1c40f;">è«‹ç™»å…¥æ‚¨çš„ Google å¸³è™Ÿä»¥åŒæ­¥æ—¥æ›†ã€‚</p>
    <div id="google-signin-button"></div> 
</div>
<div id="status-message" style="text-align: center; margin-bottom: 20px; font-weight: bold; color: #f1c40f;">è¼‰å…¥ä¸­...</div>

<div class="legend">
  <div><span class="dot" style="background:#27ae60"></span>å¯é ç´„</div>
  <div><span class="dot" style="background:#e74c3c"></span>æ‰‹å‹•é ç´„ (é»æ“Šå–æ¶ˆ)</div>
  <div><span class="dot" style="background:#f39c12"></span>**æ—¥æ›†é ç´„**</div>
  <div><span class="dot" style="background:#566573"></span>æ™‚çª—ä½”ç”¨</div>
  <div><span class="dot" style="background:#9b59b6"></span>åŒé¤¨é–‹å ´è¡çª</div>
</div>

<div class="container">
  <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div>
    <div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div>
  </div>
  <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div>
    <div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div>
  </div>
  <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div>
    <div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div>
  </div>
  <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s4"></div>
    <div id="remaining-æœ±ç ‚" class="available-slots-area"></div>
  </div>
</div>

<div id="controls">
  <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
  <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½®</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script> 

<script>
// =================================================================
// ğŸš¨ è¨­å®šå€ ğŸš¨
// 1. æ‚¨çš„ OAuth Client ID (å·²å¡«å…¥)
const CLIENT_ID = '765251081193-i8cm9ugv4k8t8upummkcugr5189157vm.apps.googleusercontent.com'; 
// 2. æ‚¨çš„æœ€æ–° GAS éƒ¨ç½² URL (å·²å¡«å…¥)
const GAS_URL = 'https://script.google.com/macros/s/AKfycby_JVIaJ2q25--1-KujTtiubTV0wLYye9ugSTcwruU54hFh-c6nKTc-72Tb9uDWu_fE6A/exec';
// 3. è«‹æ±‚æ—¥æ›†æ¬Šé™çš„ç¯„åœ
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';

// æ ¸å¿ƒé…ç½®
const CONFIG = {
  "301è™Ÿæˆ¿":      { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
  "å¤±ç‰©æ‹›é ˜":    { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
  "è—æ¨£çš„ä»£åƒ¹":  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" }, 
  "æœ±ç ‚":        { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }  
};
// =================================================================

let localStorageKey = "mishi2025_v14";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });

let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const tm = t => parseInt(t.split(":")[0]) * 60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
  let res = [];
  for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
  return res;
}

// --- Google ç™»å…¥é‚è¼¯ ---
let gisInited = false;

function gisInit() {
    // å¦‚æœå·²ç¶“ç™»å…¥éä¸” Token æœ‰æ•ˆï¼Œå‰‡ç›´æ¥å˜—è©¦è¼‰å…¥
    if (sessionStorage.getItem('google_access_token')) {
         document.getElementById('user-status').innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
         document.getElementById('google-signin-button').style.display = 'none';
         render(true);
         return;
    }

    // åˆå§‹åŒ– Google ç™»å…¥è¨­å®š
    window.google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleSignInResponse, 
        auto_select: false, 
        scope: SCOPE,
        prompt_parent_id: "google-signin-button" 
    });
    
    // æ¸²æŸ“ Google ç™»å…¥æŒ‰éˆ•
    window.google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        { theme: 'outline', size: 'large', type: 'standard', text: 'signin_with' }
    );

    gisInited = true;
    
    // å¦‚æœæ²’æœ‰ Tokenï¼Œé è¨­é¡¯ç¤ºæŒ‰éˆ•
    document.getElementById('google-signin-button').style.display = 'block';
}

// è™•ç†ç™»å…¥éŸ¿æ‡‰ (å–å¾—æ†‘è­‰)
function handleSignInResponse(resp) {
    if (resp.access_token) {
        // æˆåŠŸå–å¾— Access Tokenï¼Œå­˜å„²åˆ° sessionStorage
        sessionStorage.setItem('google_access_token', resp.access_token);
        document.getElementById('user-status').innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
        document.getElementById('google-signin-button').style.display = 'none'; 
        render(true); // é‡æ–°è¼‰å…¥æ’ç¨‹è¡¨ï¼Œé€™æ¬¡æœƒæ”œå¸¶ Token
    } else {
        document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥å¤±æ•—æˆ–å–æ¶ˆæˆæ¬Šã€‚';
    }
}

// -------------------------------------------------------------------
// æ ¸å¿ƒæ•¸æ“šè®€å– (æ–°å¢æ”œå¸¶ Access Token)
// -------------------------------------------------------------------

async function fetchCalendarBookings(gasUrl) {
    const statusEl = document.getElementById('status-message');
    const token = sessionStorage.getItem('google_access_token');
    
    if (!token) {
        statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Googleã€‚ç„¡æ³•åŒæ­¥æ—¥æ›†ã€‚';
        statusEl.style.backgroundColor = '#566573';
        return {}; 
    }
    
    statusEl.innerHTML = 'æ­£åœ¨ä½¿ç”¨æ‚¨çš„æ†‘è­‰å‘æ—¥æ›†ä¼ºæœå™¨è«‹æ±‚è³‡æ–™...';
    statusEl.style.backgroundColor = '#2c3e50';
    statusEl.style.color = '#f1c40f';

    try {
        // å°‡ Access Token ä½œç‚º URL åƒæ•¸å‚³éçµ¦ GAS
        const fetchUrl = `${gasUrl}?token=${token}`; 
        const response = await fetch(fetchUrl);
        
        if (!response.ok) {
             throw new Error(`ç¶²è·¯éŒ¯èª¤ ${response.status}`);
        }
        
        const calendarEvents = await response.json();
        
        // æª¢æŸ¥ GAS æ˜¯å¦è¿”å›éŒ¯èª¤ï¼Œç‰¹åˆ¥æ˜¯ Token éŒ¯èª¤
        if (calendarEvents.error) {
             if (calendarEvents.error === "TOKEN_INVALID" || calendarEvents.error === "API_ERROR") {
                document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥æ†‘è­‰ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ï¼';
                sessionStorage.removeItem('google_access_token'); // æ¸…é™¤ Token
                document.getElementById('google-signin-button').style.display = 'block';
                statusEl.innerHTML = 'è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é‡æ–°ç™»å…¥ã€‚';
                statusEl.style.backgroundColor = '#543030';
                throw new Error("Token/Auth Failed");
             }
             // å…¶ä»– GAS å…§éƒ¨éŒ¯èª¤
             statusEl.innerHTML = `ğŸ›‘ GAS ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤: ${calendarEvents.message || 'æœªçŸ¥'}`;
             statusEl.style.backgroundColor = '#543030';
             throw new Error("EXECUTION_FAILED");
        }


        // æˆæ¬ŠæˆåŠŸ
        statusEl.innerHTML = 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå·²åŒæ­¥æ‚¨çš„æ—¥æ›†äº‹ä»¶ã€‚';
        statusEl.style.backgroundColor = '#1e8449';
        statusEl.style.color = 'white';
        
        // è™•ç†äº‹ä»¶
        let tempExternalBookings = {};
        Object.keys(CONFIG).forEach(k => tempExternalBookings[k] = []);
        calendarEvents.forEach(event => {
            if (CONFIG[event.theme] && event.time) {
                tempExternalBookings[event.theme].push(event.time);
            }
        });
        return tempExternalBookings;


    } catch (error) {
        if (!["Token/Auth Failed", "EXECUTION_FAILED"].includes(error.message)) {
             statusEl.innerHTML = `
                <p style="color:#f39c12; font-weight:bold; margin: 0;">âš ï¸ è¼‰å…¥æ—¥æ›†è³‡æ–™å¤±æ•—ï¼</p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color:#ecf0f1;">éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
             `;
             statusEl.style.backgroundColor = '#566573';
             statusEl.style.color = 'white';
        }
        return {}; 
    }
}

// -------------------------------------------------------------------
// ç‹€æ…‹æª¢æŸ¥ã€åˆ‡æ›ã€ç¹ªè£½é‚è¼¯
// -------------------------------------------------------------------

function getStatus(theme, tVal) {
  const conf = CONFIG[theme];
  const tStr = valToStr(tVal);
  if (externalBookings[theme] && externalBookings[theme].includes(tStr)) return 'external-booked';
  if (localBookings[theme].includes(tStr)) return 'booked';
  const mate = Object.keys(CONFIG).find(k => CONFIG[k].group === conf.group && k !== theme);
  if (combinedBookings[mate] && combinedBookings[mate].includes(tStr)) return 'lobby-clash';
  for (let startStr of combinedBookings[theme]) {
    let s = tm(startStr);
    let s_block = s - conf.block_before;
    let e_block = s + conf.block_after; 
    if (tVal >= s_block && tVal < e_block) return 'blocked';
  }
  return 'available';
}

function checkConflict(theme, tVal) {
    const conf = CONFIG[theme];
    const s_new_buffer = tVal - conf.block_before;
    const e_new_buffer = tVal + conf.block_after;
    return combinedBookings[theme].some(existStr => {
      const s_exist = tm(existStr);
      const s_exist_buffer = s_exist - conf.block_before;
      const e_exist_buffer = s_exist + conf.block_after;
      if (s_new_buffer < e_exist_buffer && e_new_buffer > s_exist_buffer) {
        return true;
      }
      return false;
    });
}

function toggle(theme, time) {
  const tVal = tm(time);
  if (externalBookings[theme] && externalBookings[theme].includes(time)) {
      console.warn("æ­¤ç‚ºæ—¥æ›†é ç´„ï¼Œè«‹è‡³ Google æ—¥æ›†ä¸Šä¿®æ”¹æˆ–åˆªé™¤ã€‚");
      return; 
  }
  const idx = localBookings[theme].indexOf(time);
  if (idx > -1) {
    localBookings[theme].splice(idx,1);
  } else {
    if (getStatus(theme, tVal) !== 'available') return; 
    if (checkConflict(theme, tVal)) return;
    localBookings[theme].push(time);
  }
  localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
  render(false); 
}

function clearAll() {
    Object.keys(localBookings).forEach(key => localBookings[key] = []);
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    
    // åŒæ™‚æ¸…é™¤ sessionStorage ä¸­çš„ tokenï¼Œå¼·åˆ¶é‡æ–°ç™»å…¥
    sessionStorage.removeItem('google_access_token'); 
    location.reload(); 
}

function copyAvailableSlots(theme) {
  const element = document.getElementById(`remaining-${theme}`);
  const slotsText = element.querySelector('.slot-text').innerText;
  const textToCopy = `${theme}å‰©é¤˜å ´æ¬¡ï¼š${slotsText}`;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        const button = element.querySelector('.copy-button');
        button.innerText = 'å·²è¤‡è£½ï¼';
        setTimeout(() => button.innerText = 'ä¸€éµè¤‡è£½', 1500);
      })
      .catch(err => {
        const button = element.querySelector('.copy-button');
        button.innerText = 'è¤‡è£½å¤±æ•—';
      });
  } else {
    const button = element.querySelector('.copy-button');
    button.innerText = 'è¤‡è£½å¤±æ•— (è«‹æ‰‹å‹•)';
  }
}

async function render(shouldFetch = true) {
    if (!gisInited) { gisInit(); }

    let fetchError = false;
    if (shouldFetch) {
        const fetchedEvents = await fetchCalendarBookings(GAS_URL);
        externalBookings = fetchedEvents;
        const statusEl = document.getElementById('status-message');
        if (statusEl.innerHTML.includes('âŒ') || statusEl.innerHTML.includes('ğŸ›‘') || statusEl.innerHTML.includes('âš ï¸')) {
            fetchError = true;
        }
    }
    
    combinedBookings = JSON.parse(JSON.stringify(localBookings));
    Object.keys(CONFIG).forEach(theme => {
        if (externalBookings[theme]) {
            externalBookings[theme].forEach(time => {
                if (!combinedBookings[theme].includes(time)) {
                    combinedBookings[theme].push(time);
                }
            });
        }
        if (!combinedBookings[theme]) combinedBookings[theme] = []; 
    });
    
    if (fetchError && shouldFetch) {
        Object.keys(CONFIG).forEach(theme => {
            document.getElementById(CONFIG[theme].id).innerHTML = `<div style="color:#e74c3c; text-align:center; padding: 20px;">è«‹å…ˆè§£æ±ºä¸Šæ–¹æç¤ºçš„éŒ¯èª¤æˆ–ç™»å…¥ã€‚</div>`;
            document.getElementById(`remaining-${theme}`).innerHTML = `<strong>å‰©é¤˜å ´æ¬¡ï¼š</strong><span class="slot-text" style="color:#e74c3c;">ç„¡æ³•åŒæ­¥</span>`;
        });
        return;
    }

    const allTimes = {};
    
    Object.keys(CONFIG).forEach(theme => {
      const conf = CONFIG[theme];
      const el = document.getElementById(conf.id);
      const times = generateTimes(conf.interval);
      let availableTimes = [];

      el.innerHTML = times.map(t => {
        const tVal = tm(t);
        const s = getStatus(theme, tVal);
        let label = t;
        let cls = s;
        let onClick = `onclick="toggle('${theme}','${t}')"`;
        
        if (s === 'booked') { } 
        else if (s === 'external-booked') {
          cls = 'external-booked'; label = t + ' (æ—¥æ›†)'; onClick = '';
        }
        else if (s === 'lobby-clash') { 
          cls = 'lobby-clash'; label = 'é–‹å ´è¡çª'; onClick = '';
        }
        else if (s === 'blocked') { 
          const totalMinutes = conf.block_before + conf.block_after;
          label = `ä½”ç”¨ (${totalMinutes}åˆ†)`; onClick = '';
        } else {
          if (checkConflict(theme, tVal)) {
              cls = 'blocked'; label = 'æ’ç¨‹è¡çª'; onClick = '';
          } else {
              availableTimes.push(t);
          }
        }
        return `<div class="slot ${cls}" ${onClick}>${label}</div>`;
      }).join('');
      allTimes[theme] = availableTimes;
    });

    Object.keys(CONFIG).forEach(theme => {
      const areaEl = document.getElementById(`remaining-${theme}`);
      const availableSlots = allTimes[theme] || [];
      const slotsText = availableSlots.join(', ') || 'æœ¬æ—¥ç„¡å‰©é¤˜å ´æ¬¡';
      areaEl.innerHTML = `
        <div style="display: flex; align-items: flex-start; width: 100%;">
            <strong>å‰©é¤˜å ´æ¬¡ï¼š</strong>
            <div class="slot-text-container">
                <span class="slot-text">${slotsText}</span>
            </div>
            <button class="copy-button" onclick="copyAvailableSlots('${theme}')">ä¸€éµè¤‡è£½</button>
        </div>
      `;
    });
}

// ç¢ºä¿é¦–æ¬¡è¼‰å…¥æ™‚åˆå§‹åŒ– Google ç™»å…¥
window.onload = gisInit;
</script>
</body>
</html>