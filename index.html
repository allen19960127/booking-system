<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ± (2025æœ€çµ‚ç‰ˆ)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; color: #2c3e50; padding: 20px; margin: 0; line-height: 1.6; }
    h1 { text-align: center; margin: 20px 0 10px 0; font-size: 2.2em; color: #34495e; font-weight: 700; }
    #auth-container { text-align: center; margin-bottom: 25px; padding: 15px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
    #user-status { margin: 5px 0 15px 0; font-size: 1.1em; color: #2980b9; font-weight: 500; }
    #status-message { text-align: center; margin-bottom: 20px; font-weight: bold; padding: 12px; border-radius: 8px; transition: background-color 0.3s; color: white; }
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; }
    .theme { background-color: #ffffff; padding: 20px; border-radius: 12px; width: 100%; max-width: 650px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s; border-top: 5px solid #3498db; }
    .theme h2 { text-align: center; background-color: #ecf0f1; padding: 12px; border-radius: 8px; margin: 0 0 20px 0; font-size: 1.5em; color: #34495e; }
    .slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    .slot { padding: 10px 5px; text-align: center; border-radius: 6px; font-weight: 500; font-size: 0.9em; transition: all 0.15s; user-select: none; border: 1px solid transparent; line-height: 1.2; }
    .available { background-color: #2ecc71; color: white; cursor: pointer; border-color: #27ae60; }
    .available:hover { background-color: #27ae60; transform: translateY(-1px); }
    .booked { background-color: #e74c3c; color: white; cursor: pointer; border-color: #c0392b; }
    .booked:hover { background-color: #c0392b; transform: translateY(-1px); }
    .blocked { background-color: #bdc3c7; color: #7f8c8d; cursor: not-allowed; opacity: 0.8; font-size: 0.8em; border-color: #95a5a6; }
    .lobby-clash { background-color: #9b59b6; color: white; border-color: #8e44ad; cursor: not-allowed; }
    .external-booked { background-color: #f39c12; color: white; cursor: not-allowed; font-weight: 700; border-color: #e67e22; }
    .available-slots-area { margin-top: 25px; padding: 15px 0; border-top: 1px solid #ecf0f1; display: flex; flex-direction: column; align-items: flex-start; background-color: #f8f9fa; padding: 15px; border-radius: 8px; }
    .available-slots-area strong { display: block; margin-bottom: 8px; color: #e67e22; font-weight: 700; }
    .slot-text-container { width: 100%; margin-bottom: 10px; }
    .copy-button { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background 0.2s, transform 0.1s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .copy-button:hover { background-color: #2980b9; transform: translateY(-1px); }
    #controls { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 999; }
    #controls button { border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: background 0.2s, transform 0.1s; }
    #clear { background-color: #e74c3c; color: white; }
    #clear:hover { background-color: #c0392b; transform: translateY(-1px); }
    #refresh { background-color: #3498db; color: white; }
    #refresh:hover { background-color: #2980b9; transform: translateY(-1px); }
    .legend { text-align: center; margin-bottom: 25px; font-size: 0.9em; display: flex; justify-content: center; gap: 20px; color: #555; flex-wrap: wrap; }
    .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; border: 1px solid rgba(0,0,0,0.1); }
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±</h1>

<div id="auth-container">
    <p id="user-status">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
    <div id="google-signin-button"></div> 
</div>
<div id="status-message" style="background-color: #bdc3c7;">è¼‰å…¥ä¸­...</div>

<div class="legend">
    <div><span class="dot" style="background-color:#2ecc71"></span>å¯é ç´„</div>
    <div><span class="dot" style="background-color:#e74c3c"></span>æ‰‹å‹•é ç´„</div>
    <div><span class="dot" style="background-color:#f39c12"></span>æ—¥æ›†é ç´„</div>
    <div><span class="dot" style="background-color:#bdc3c7"></span>æ™‚çª—ä½”ç”¨</div>
    <div><span class="dot" style="background-color:#9b59b6"></span>åŒé¤¨è¡çª</div>
</div>

<div class="container">
    <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div><div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div></div>
    <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div><div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div></div>
    <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div><div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div></div>
    <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†) </h2><div class="slots" id="s4"></div><div id="remaining-æœ±ç ‚" class="available-slots-area"></div></div>
</div>

<div id="controls">
    <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½® (ç™»å‡º)</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// ================== ä½ çš„æ­£ç¢º GAS URL å·²æ›¿æ› ==================
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';
const GAS_URL = 'https://script.google.com/macros/s/AKfycbymuvbDrqBjPbAGdbF8srXewsmIpWB0sUkWteupKJrSZNxZWueoZCIXsrTEE5PJCxIP9Q/exec';
// ===============================================================

const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
let localStorageKey = "mishi2025_v15";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const CONFIG = {
    "301è™Ÿæˆ¿":     { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
    "å¤±ç‰©æ‹›é ˜":   { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
    "è—æ¨£çš„ä»£åƒ¹": { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" },
    "æœ±ç ‚":       { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }
};

const tm = t => parseInt(t.split(":")[0])*60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
    let res = [];
    for(let t=630; t<=1260; t+=interval) res.push(valToStr(t));
    return res;
}

// Google ç™»å…¥ (Redirect + Hash æ¨¡å¼)
function gisInit() {
    const userStatusEl = document.getElementById('user-status');
    const signInButtonEl = document.getElementById('google-signin-button');

    // 1. å¾ #access_token å–å‡ºå‰›ç™»å…¥å›å‚³çš„ token
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get('access_token');

    if (accessToken) {
        sessionStorage.setItem('google_access_token', accessToken);
        history.replaceState(null, null, window.location.pathname);
    }

    if (sessionStorage.getItem('google_access_token')) {
        userStatusEl.innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼ŒåŒæ­¥æ—¥æ›†ä¸­...';
        signInButtonEl.style.display = 'none';
        render(true);
        return;
    }

    // åˆå§‹åŒ– Google Identity Services
    google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: () => {}, 
        ux_mode: 'redirect',
        redirect_uri: window.location.href,
        scope: SCOPE
    });

    userStatusEl.innerHTML = 'âš ï¸ è«‹é»ä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google ä»¥åŒæ­¥æ—¥æ›†';
    signInButtonEl.style.display = 'block';
    google.accounts.id.renderButton(signInButtonEl, { theme: "outline", size: "large" });
}

// ç™»å‡º & æ¸…ç©º
function clearAll() {
    sessionStorage.clear();
    localStorage.removeItem(localStorageKey);
    location.reload();
}

// é»æ“Šæ™‚é–“æ§½
function toggleSlot(theme, time, el) {
    if (el.classList.contains('blocked') || el.classList.contains('external-booked') || el.classList.contains('lobby-clash')) return;
    if (el.classList.contains('booked')) {
        localBookings[theme] = localBookings[theme].filter(t => t !== time);
        el.classList.remove('booked'); el.classList.add('available');
    } else {
        localBookings[theme].push(time);
        el.classList.remove('available'); el.classList.add('booked');
    }
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    updateCombinedBookings();
    renderSlots();
    updateRemainingSlotsDisplay();
}

function calculateSlotStatus(theme, timeStr) {
    const config = CONFIG[theme];
    const currentTime = tm(timeStr);
    const duration = config.dur;

    if (externalBookings[theme]?.includes(timeStr)) return 'external-booked';
    if (localBookings[theme]?.includes(timeStr)) return 'booked';

    let blocked = false, lobbyClash = false;

    Object.keys(combinedBookings).forEach(other => {
        const o = CONFIG[other];
        combinedBookings[other].forEach(bt => {
            const b = tm(bt);
            const start = b - o.block_before;
            const end   = b + o.dur + o.block_after;
            const s = currentTime;
            const e = currentTime + duration;
            if (Math.max(s, start) < Math.min(e, end)) {
                if (theme === other) blocked = true;
                else if (config.group === o.group) lobbyClash = true;
                else blocked = true;
            }
        });
    });

    if (lobbyClash) return 'lobby-clash';
    if (blocked) return 'blocked';
    return 'available';
}

function updateCombinedBookings() {
    combinedBookings = JSON.parse(JSON.stringify(localBookings));
    Object.keys(externalBookings).forEach(k => {
        externalBookings[k].forEach(t => {
            if (!combinedBookings[k].includes(t)) combinedBookings[k].push(t);
        });
    });
}

function renderSlots() {
    Object.keys(CONFIG).forEach(theme => {
        const {id, interval} = CONFIG[theme];
        const times = generateTimes(interval);
        let html = '';
        times.forEach(t => {
            const status = calculateSlotStatus(theme, t);
            let label = t;
            if (status === 'blocked') label += '<br>(è¢«ä½”ç”¨)';
            else if (status === 'lobby-clash') label += '<br>(è¡çª)';
            else if (status === 'external-booked') label += '<br>(æ—¥æ›†å·²è¨‚)';
            html += `<div class="slot ${status}" onclick="toggleSlot('${theme}','${t}',this)">${label}</div>`;
        });
        document.getElementById(id).innerHTML = html;
    });
    updateRemainingSlotsDisplay();
}

function updateRemainingSlotsDisplay() {
    Object.keys(CONFIG).forEach(theme => {
        const area = document.getElementById(`remaining-${theme}`);
        const times = generateTimes(CONFIG[theme].interval);
        const avail = times.filter(t => calculateSlotStatus(theme, t) === 'available');
        const text = avail.length ? avail.join(', ') : 'ä»Šæ—¥ç„¡ç©ºæª”';
        const fullText = `${theme} å¯é ç´„æ™‚é–“ï¼š${avail.join(', ')}`;
        area.innerHTML = `
            <strong>${theme} å¯é ç´„æ™‚é–“ (å…± ${avail.length} æª”)ï¼š</strong>
            <div class="slot-text-container">${text.length > 200 ? avail.slice(0,15).join(', ')+'...' : text}</div>
            <button class="copy-button" onclick="copyToClipboard('${fullText}')">è¤‡è£½å…¨éƒ¨</button>
        `;
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("âœ… å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nå…§å®¹ï¼š\n" + text);
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—: ', err);
        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
    });
}

// å¾ GAS å–å¾—æ—¥æ›†äº‹ä»¶
async function fetchCalendarBookings() {
    const token = sessionStorage.getItem('google_access_token');
    const statusEl = document.getElementById('status-message');
    if (!token) { 
        statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Google'; 
        statusEl.style.backgroundColor = '#f39c12'; 
        return {}; 
    }

    statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨è®€å–æ‚¨çš„ Google æ—¥æ›†...'; 
    statusEl.style.backgroundColor = '#3498db';

    try {
        const res = await fetch(GAS_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({token})
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

        const data = await res.json();
        if (data.error) throw new Error(data.message || data.error);

        statusEl.innerHTML = 'âœ… æ—¥æ›†åŒæ­¥å®Œæˆï¼'; 
        statusEl.style.backgroundColor = '#2ecc71';

        const ext = {};
        Object.keys(CONFIG).forEach(k => ext[k] = []);
        data.forEach(ev => {
            if (CONFIG[ev.theme] && ev.time) ext[ev.theme].push(ev.time);
        });
        return ext;
    } catch (err) {
        statusEl.innerHTML = `âŒ æ—¥æ›†è®€å–å¤±æ•—ï¼š${err.message}`;
        statusEl.style.backgroundColor = '#e74c3c';
        console.error('æ—¥æ›†åŒæ­¥éŒ¯èª¤:', err);
        return {};
    }
}

async function render(fetch = true) {
    if (fetch) externalBookings = await fetchCalendarBookings();
    updateCombinedBookings();
    renderSlots();
}

// åˆå§‹åŒ–
window.onload = () => {
    Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });
    gisInit();
};
</script>
</body>
</html>