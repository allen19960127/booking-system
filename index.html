<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ± (ç¾åŒ–ç‰ˆ)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
Â  /* æ¨£å¼ç¢¼ä¿æŒä¸è®Š */
Â  body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; color: #2c3e50; padding: 20px; margin: 0; line-height: 1.6; }
Â  h1 { text-align: center; margin: 20px 0 10px 0; font-size: 2.2em; color: #34495e; font-weight: 700; }
Â  #auth-container { text-align: center; margin-bottom: 25px; padding: 15px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
Â  #user-status { margin: 5px 0 15px 0; font-size: 1.1em; color: #2980b9; font-weight: 500; }
Â  #status-message { text-align: center; margin-bottom: 20px; font-weight: bold; padding: 12px; border-radius: 8px; transition: background-color 0.3s; color: white; }
Â  .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; }
Â  .theme { background-color: #ffffff; padding: 20px; border-radius: 12px; width: 100%; max-width: 650px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s; border-top: 5px solid #3498db; }
Â  .theme h2 { text-align: center; background-color: #ecf0f1; padding: 12px; border-radius: 8px; margin: 0 0 20px 0; font-size: 1.5em; color: #34495e; }
Â  .slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
Â  .slot { padding: 10px 5px; text-align: center; border-radius: 6px; font-weight: 500; font-size: 0.9em; transition: all 0.15s; user-select: none; border: 1px solid transparent; line-height: 1.2; }
Â  .available { background-color: #2ecc71; color: white; cursor: pointer; border-color: #27ae60; }
Â  .available:hover { background-color: #27ae60; transform: translateY(-1px); }
Â  .booked { background-color: #e74c3c; color: white; cursor: pointer; border-color: #c0392b; }
Â  .booked:hover { background-color: #c0392b; transform: translateY(-1px); }
Â  .blocked { background-color: #bdc3c7; color: #7f8c8d; cursor: not-allowed; opacity: 0.8; font-size: 0.8em; border-color: #95a5a6; }
Â  .lobby-clash { background-color: #9b59b6; color: white; border-color: #8e44ad; cursor: not-allowed; }
Â  .external-booked { background-color: #f39c12; color: white; cursor: not-allowed; font-weight: 700; border-color: #e67e22; }
Â  .available-slots-area { margin-top: 25px; padding: 15px 0; border-top: 1px solid #ecf0f1; display: flex; flex-direction: column; align-items: flex-start; background-color: #f8f9fa; padding: 15px; border-radius: 8px; }
Â  .available-slots-area strong { display: block; margin-bottom: 8px; color: #e67e22; font-weight: 700; }
Â  .slot-text-container { width: 100%; margin-bottom: 10px; }
Â  .copy-button { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background 0.2s, transform 0.1s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
Â  .copy-button:hover { background-color: #2980b9; transform: translateY(-1px); }
Â  #controls { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 999; }
Â  #controls button { border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: background 0.2s, transform 0.1s; }
Â  #clear { background-color: #e74c3c; color: white; }
Â  #clear:hover { background-color: #c0392b; transform: translateY(-1px); }
Â  #refresh { background-color: #3498db; color: white; }
Â  #refresh:hover { background-color: #2980b9; transform: translateY(-1px); }
Â  .legend { text-align: center; margin-bottom: 25px; font-size: 0.9em; display: flex; justify-content: center; gap: 20px; color: #555; }
Â  .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; border: 1px solid rgba(0, 0, 0, 0.1); }
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±</h1>

<div id="auth-container">
Â  Â  <p id="user-status">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
Â  Â  <div id="google-signin-button"></div>Â 
</div>
<div id="status-message" style="background-color: #bdc3c7; color: white;">è¼‰å…¥ä¸­...</div>

<div class="legend">
Â  <div><span class="dot" style="background-color:#2ecc71"></span>å¯é ç´„</div>
Â  <div><span class="dot" style="background-color:#e74c3c"></span>æ‰‹å‹•é ç´„</div>
Â  <div><span class="dot" style="background-color:#f39c12"></span>æ—¥æ›†é ç´„</div>
Â  <div><span class="dot" style="background-color:#bdc3c7"></span>æ™‚çª—ä½”ç”¨</div>
Â  <div><span class="dot" style="background-color:#9b59b6"></span>åŒé¤¨è¡çª</div>
</div>

<div class="container">
Â  <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div>
Â  Â  <div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div>
Â  Â  <div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div>
Â  Â  <div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†) </h2><div class="slots" id="s4"></div>
Â  Â  <div id="remaining-æœ±ç ‚" class="available-slots-area"></div>
Â  </div>
</div>

<div id="controls">
Â  <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
Â  <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½® (ç™»å‡º)</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>Â 

<script>
// =================================================================
// ğŸš¨ è¨­å®šå€ - è«‹æ›¿æ›ä»¥ä¸‹å…©å€‹åƒæ•¸ ğŸš¨
// =================================================================
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';Â 
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyEmwsxlnr7Xy7yduekMsNhSJrnNNMWygwh8Rqaw81hQbmJUFkhedRR2Xp4gu2Lip59/exec';
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';

// æ ¸å¿ƒé…ç½® (ä¿æŒä¸è®Š)
const CONFIG = {
Â  "301è™Ÿæˆ¿":Â  Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
Â  "å¤±ç‰©æ‹›é ˜":Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
Â  "è—æ¨£çš„ä»£åƒ¹":Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" },Â 
Â  "æœ±ç ‚":Â  Â  Â  Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }Â Â 
};
// =================================================================
let localStorageKey = "mishi2025_v14";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });

let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const tm = t => parseInt(t.split(":")[0]) * 60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
Â  let res = [];
Â  for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
Â  return res;
}

// --- Google ç™»å…¥é‚è¼¯ (Redirect Mode) ---
let gisInited = false;

function gisInit() {
Â  Â  const userStatusEl = document.getElementById('user-status');
Â  Â  const signInButtonEl = document.getElementById('google-signin-button');

Â  Â  // 1. æª¢æŸ¥ç¶²å€åˆ—æ˜¯å¦åŒ…å« Google å°å›çš„ Token
Â  Â  const urlParams = new URLSearchParams(window.location.hash.substring(1));
Â  Â  const accessToken = urlParams.get('access_token');

Â  Â  if (accessToken) {
Â  Â  Â  Â  // ç™»å…¥æˆåŠŸï¼Œå„²å­˜ Token ä¸¦æ¸…ç†ç¶²å€åˆ—
Â  Â  Â  Â  sessionStorage.setItem('google_access_token', accessToken);
Â  Â  Â  Â  history.replaceState(null, null, window.location.pathname);Â 
Â  Â  }

Â  Â  // 2. æª¢æŸ¥æ˜¯å¦æœ‰ Token
Â  Â  if (sessionStorage.getItem('google_access_token')) {
Â  Â  Â  Â  userStatusEl.innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
Â  Â  Â  Â  signInButtonEl.style.display = 'none';
Â  Â  Â  Â  render(true);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. åˆå§‹åŒ– Google é‡æ–°å°å‘ç™»å…¥è¨­å®š
Â  Â  window.google.accounts.id.initialize({
Â  Â  Â  Â  client_id: CLIENT_ID,
Â  Â  Â  Â  callback: null, 
Â  Â  Â  Â  flow: 'implicit',
Â  Â  Â  Â  ux_mode: 'redirect', 
Â  Â  Â  Â  // ***** ä¿®æ­£ï¼šä½¿ç”¨ window.location.href ç¢ºä¿å›å°æ­£ç¢ºæ€§ *****
Â  Â  Â  Â  redirect_uri: window.location.href,Â 
Â  Â  Â  Â  scope: SCOPE
Â  Â  });
Â  Â Â 
Â  Â  // 4. æ¸²æŸ“ç™»å…¥æŒ‰éˆ•
Â  Â  userStatusEl.innerHTML = 'âš ï¸ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google é€²è¡ŒåŒæ­¥ã€‚';
Â  Â  signInButtonEl.style.display = 'block';
Â  Â Â 
Â  Â  window.google.accounts.id.renderButton(
Â  Â  Â  Â  signInButtonEl,
Â  Â  Â  Â  // ***** å„ªåŒ–ï¼šç§»é™¤ type å’Œ textï¼Œè®“ Google é è¨­æ¸²æŸ“ *****
Â  Â  Â  Â  { theme: 'outline', size: 'large' }
Â  Â  );

Â  Â  gisInited = true;
Â  Â  render(false); 
}
// ... [å…¶é¤˜ JS å‡½å¼ä¿æŒä¸è®Š]
// ...
// ... [å…¶é¤˜ JS å‡½å¼ä¿æŒä¸è®Š]
// ...
// ... [å…¶é¤˜ JS å‡½å¼ä¿æŒä¸è®Š]
// ...

async function fetchCalendarBookings(gasUrl) {
Â  Â  const statusEl = document.getElementById('status-message');
Â  Â  const token = sessionStorage.getItem('google_access_token');
Â  Â Â 
Â  Â  if (!token) {
Â  Â  Â  Â  statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Googleã€‚ç„¡æ³•åŒæ­¥æ—¥æ›†ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#f39c12';
Â  Â  Â  Â  return {};Â 
Â  Â  }
Â  Â Â 
Â  Â  statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨ä½¿ç”¨æ‚¨çš„æ†‘è­‰å‘æ—¥æ›†ä¼ºæœå™¨è«‹æ±‚è³‡æ–™...';
Â  Â  statusEl.style.backgroundColor = '#3498db';

Â  Â  try {
Â  Â  Â  Â  const fetchUrl = `${gasUrl}?token=${token}`;Â 
Â  Â  Â  Â  const response = await fetch(fetchUrl);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) {Â 
Â  Â  Â  Â  Â  throw new Error(`ç¶²è·¯éŒ¯èª¤ ${response.status} (${response.statusText})`);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const calendarEvents = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æª¢æŸ¥ GAS è¿”å›çš„è‡ªè¨‚éŒ¯èª¤
Â  Â  Â  Â  if (calendarEvents.error) {
Â  Â  Â  Â  Â  Â  if (calendarEvents.error === "TOKEN_INVALID" || calendarEvents.error === "API_ERROR") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥æ†‘è­‰ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€ï¼';
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('google_access_token');Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `è«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€é‡æ–°é–‹å§‹ç™»å…¥ã€‚éŒ¯èª¤: ${calendarEvents.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#e74c3c';
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Auth/API Failed");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `ğŸ›‘ GAS ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤: ${calendarEvents.message || 'æœªçŸ¥'}`;
Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#e74c3c';
Â  Â  Â  Â  Â  Â  throw new Error("EXECUTION_FAILED");
Â  Â  Â  Â  }


Â  Â  Â  Â  // æˆæ¬ŠæˆåŠŸ
Â  Â  Â  Â  statusEl.innerHTML = 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå·²åŒæ­¥æ‚¨çš„æ—¥æ›†äº‹ä»¶ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#2ecc71';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è™•ç†äº‹ä»¶
Â  Â  Â  Â  let tempExternalBookings = {};
Â  Â  Â  Â  Object.keys(CONFIG).forEach(k => tempExternalBookings[k] = []);
Â  Â  Â  Â  calendarEvents.forEach(event => {
Â  Â  Â  Â  Â  Â  if (CONFIG[event.theme] && event.time) {
Â  Â  Â  Â  Â  Â  Â  Â  tempExternalBookings[event.theme].push(event.time);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return tempExternalBookings;


Â  Â  } catch (error) {
Â  Â  Â  Â  if (!["Auth/API Failed", "EXECUTION_FAILED"].includes(error.message)) {
Â  Â  Â  Â  Â  Â  Â statusEl.innerHTML = `<p style="color:white; font-weight:bold; margin: 0;">âš ï¸ è¼‰å…¥æ—¥æ›†è³‡æ–™å¤±æ•—ï¼</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color:#ecf0f1;">éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
Â  Â  Â  Â  Â  Â  Â statusEl.style.backgroundColor = '#95a5a6';
Â  Â  Â  Â  }
Â  Â  Â  Â  return {};Â 
Â  Â  }
}
// ... [å…¶é¤˜ JS å‡½å¼ä¿æŒä¸è®Š]
// ...
// ... [å…¶é¤˜ JS å‡½å¼ä¿æŒä¸è®Š]
// ...
function render(shouldFetch = true) {
    // ... (ä¿æŒä¸è®Š)
}

// ç¢ºä¿é¦–æ¬¡è¼‰å…¥æ™‚åˆå§‹åŒ– Google ç™»å…¥
window.onload = gisInit;
</script>
</body>
</html>