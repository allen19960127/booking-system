<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ± (ç¾åŒ–ç‰ˆ)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
Â  /* å…¨åŸŸè¨­å®šèˆ‡å­—é«” */
Â  body {
Â  Â  font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
Â  Â  background-color: #f0f4f8; /* æŸ”å’Œæ·ºè—èƒŒæ™¯ */
Â  Â  color: #2c3e50;
Â  Â  padding: 20px;
Â  Â  margin: 0;
Â  Â  line-height: 1.6;
Â  }
Â  h1 {
Â  Â  text-align: center;
Â  Â  margin: 20px 0 10px 0;
Â  Â  font-size: 2.2em;
Â  Â  color: #34495e;
Â  Â  font-weight: 700;
Â  }
Â  
Â  /* ç‹€æ…‹èˆ‡ç™»å…¥å€ */
Â  #auth-container {
Â  Â  text-align: center;
Â  Â  margin-bottom: 25px;
Â  Â  padding: 15px;
Â  Â  background-color: #ffffff;
Â  Â  border-radius: 12px;
Â  Â  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
Â  }
Â  #user-status {
Â  Â  margin: 5px 0 15px 0;
Â  Â  font-size: 1.1em;
Â  Â  color: #2980b9;
Â  Â  font-weight: 500;
Â  }
Â  #status-message {
Â  Â  text-align: center;
Â  Â  margin-bottom: 20px;
Â  Â  font-weight: bold;
Â  Â  padding: 12px;
Â  Â  border-radius: 8px;
Â  Â  transition: background-color 0.3s;
Â  Â  color: white; /* ç‹€æ…‹è¨Šæ¯æ–‡å­—ç‚ºç™½è‰² */
Â  }
Â  
Â  /* å®¹å™¨èˆ‡ä¸»é¡Œå€å¡Š */
Â  .container {
Â  Â  display: flex;
Â  Â  flex-wrap: wrap;
Â  Â  justify-content: center;
Â  Â  gap: 25px;
Â  }
Â  .theme {
Â  Â  background-color: #ffffff;
Â  Â  padding: 20px;
Â  Â  border-radius: 12px;
Â  Â  width: 100%;
Â  Â  max-width: 650px;
Â  Â  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
Â  Â  transition: transform 0.3s;
Â  Â  border-top: 5px solid #3498db; /* å¢åŠ å“ç‰Œè‰²è£é£¾ */
Â  }
Â  .theme h2 {
Â  Â  text-align: center;
Â  Â  background-color: #ecf0f1; /* æ¨™é¡Œæ·ºç°è‰²èƒŒæ™¯ */
Â  Â  padding: 12px;
Â  Â  border-radius: 8px;
Â  Â  margin: 0 0 20px 0;
Â  Â  font-size: 1.5em;
Â  Â  color: #34495e;
Â  }
Â  .slots {
Â  Â  display: grid;
Â  Â  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
Â  Â  gap: 8px;
Â  }
Â  
Â  /* æ™‚é–“æ§½ç‹€æ…‹ */
Â  .slot {
Â  Â  padding: 10px 5px;
Â  Â  text-align: center;
Â  Â  border-radius: 6px;
Â  Â  font-weight: 500;
Â  Â  font-size: 0.9em;
Â  Â  transition: all 0.15s;
Â  Â  user-select: none;
Â  Â  border: 1px solid transparent;
Â  Â  line-height: 1.2;
Â  }
Â  .available {
Â  Â  background-color: #2ecc71; /* ç¶ è‰² */
Â  Â  color: white;
Â  Â  cursor: pointer;
Â  Â  border-color: #27ae60;
Â  }
Â  .available:hover {
Â  Â  background-color: #27ae60;
Â  Â  transform: translateY(-1px);
Â  }
Â  .booked {
Â  Â  background-color: #e74c3c; /* ç´…è‰² */
Â  Â  color: white;
Â  Â  cursor: pointer;
Â  Â  border-color: #c0392b;
Â  }
Â  .booked:hover {
Â  Â  background-color: #c0392b;
Â  Â  transform: translateY(-1px);
Â  }
Â  .blocked {
Â  Â  background-color: #bdc3c7; /* æ·ºç°è‰² */
Â  Â  color: #7f8c8d;
Â  Â  cursor: not-allowed;
Â  Â  opacity: 0.8;
Â  Â  font-size: 0.8em;
Â  Â  border-color: #95a5a6;
Â  }
Â  .lobby-clash {
Â  Â  background-color: #9b59b6; /* ç´«è‰² */
Â  Â  color: white;
Â  Â  border-color: #8e44ad;
Â  Â  cursor: not-allowed;
Â  }
Â  .external-booked {
Â  Â  background-color: #f39c12; /* æ©˜è‰² (æ—¥æ›†é ç´„) */
Â  Â  color: white;
Â  Â  cursor: not-allowed;
Â  Â  font-weight: 700;
Â  Â  border-color: #e67e22;
Â  }

Â  /* å‰©é¤˜å ´æ¬¡èˆ‡è¤‡è£½å€å¡Š */
Â  .available-slots-area {
Â  Â  margin-top: 25px;
Â  Â  padding: 15px 0;
Â  Â  border-top: 1px solid #ecf0f1;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: flex-start;
Â  Â  background-color: #f8f9fa; /* è¼•å¾®åº•è‰²å€åˆ† */
Â  Â  padding: 15px;
Â  Â  border-radius: 8px;
Â  }
Â  .available-slots-area strong {
Â  Â  display: block;
Â  Â  margin-bottom: 8px;
Â  Â  color: #e67e22;
Â  Â  font-weight: 700;
Â  }
Â  .slot-text-container {
Â  Â  width: 100%;
Â  Â  margin-bottom: 10px;
Â  }
Â  .copy-button {
Â  Â  background-color: #3498db;
Â  Â  color: white;
Â  Â  border: none;
Â  Â  padding: 10px 20px;
Â  Â  border-radius: 5px;
Â  Â  cursor: pointer;
Â  Â  font-size: 0.9em;
Â  Â  transition: background 0.2s, transform 0.1s;
Â  Â  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
Â  }
Â  .copy-button:hover {
Â  Â  background-color: #2980b9;
Â  Â  transform: translateY(-1px);
Â  }

Â  /* æ§åˆ¶æŒ‰éˆ•å€ */
Â  #controls {
Â  Â  position: fixed;
Â  Â  bottom: 20px;
Â  Â  right: 20px;
Â  Â  display: flex;
Â  Â  gap: 10px;
Â  Â  z-index: 999;
Â  }
Â  #controls button {
Â  Â  border: none;
Â  Â  padding: 12px 20px;
Â  Â  border-radius: 8px;
Â  Â  font-weight: bold;
Â  Â  cursor: pointer;
Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  Â  transition: background 0.2s, transform 0.1s;
Â  }
Â  #clear {
Â  Â  background-color: #e74c3c;
Â  Â  color: white;
Â  }
Â  #clear:hover {
Â  Â  background-color: #c0392b;
Â  Â  transform: translateY(-1px);
Â  }
Â  #refresh {
Â  Â  background-color: #3498db;
Â  Â  color: white;
Â  }
Â  #refresh:hover {
Â  Â  background-color: #2980b9;
Â  Â  transform: translateY(-1px);
Â  }

Â  /* åœ–ä¾‹å€ */
Â  .legend {
Â  Â  text-align: center;
Â  Â  margin-bottom: 25px;
Â  Â  font-size: 0.9em;
Â  Â  display: flex;
Â  Â  justify-content: center;
Â  Â  gap: 20px;
Â  Â  color: #555;
Â  }
Â  .dot {
Â  Â  display: inline-block;
Â  Â  width: 10px;
Â  Â  height: 10px;
Â  Â  border-radius: 50%;
Â  Â  margin-right: 5px;
Â  Â  border: 1px solid rgba(0, 0, 0, 0.1);
Â  }
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±</h1>

<div id="auth-container">
Â  Â  <p id="user-status">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
Â  Â  <div id="google-signin-button"></div>Â 
</div>
<div id="status-message" style="background-color: #bdc3c7; color: white;">è¼‰å…¥ä¸­...</div>

<div class="legend">
Â  <div><span class="dot" style="background-color:#2ecc71"></span>å¯é ç´„</div>
Â  <div><span class="dot" style="background-color:#e74c3c"></span>æ‰‹å‹•é ç´„</div>
Â  <div><span class="dot" style="background-color:#f39c12"></span>æ—¥æ›†é ç´„</div>
Â  <div><span class="dot" style="background-color:#bdc3c7"></span>æ™‚çª—ä½”ç”¨</div>
Â  <div><span class="dot" style="background-color:#9b59b6"></span>åŒé¤¨è¡çª</div>
</div>

<div class="container">
Â  <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div>
Â  Â  <div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div>
Â  Â  <div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div>
Â  Â  <div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†)Â </h2><div class="slots" id="s4"></div>
Â  Â  <div id="remaining-æœ±ç ‚" class="available-slots-area"></div>
Â  </div>
</div>

<div id="controls">
Â  <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
Â  <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½® (ç™»å‡º)</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>Â 

<script>
// =================================================================
// ğŸš¨ è¨­å®šå€ - è«‹æ›¿æ›ä»¥ä¸‹å…©å€‹åƒæ•¸ ğŸš¨
// =================================================================
// 1. æ‚¨çš„ OAuth Client ID
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';Â 
// 2. æ‚¨çš„æœ€æ–° GAS éƒ¨ç½² URL (å¿…é ˆæ˜¯ /exec çµå°¾)
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxqORdadS4SOhXEj-yegDBg41Iz6NF2laGYGHeF3-UNTXwIwu7ewnykRw9QIhrBI5n5/exec';
// 3. è«‹æ±‚æ—¥æ›†æ¬Šé™çš„ç¯„åœ
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';

// æ ¸å¿ƒé…ç½® (ä¿æŒä¸è®Š)
const CONFIG = {
Â  "301è™Ÿæˆ¿":Â  Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
Â  "å¤±ç‰©æ‹›é ˜":Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
Â  "è—æ¨£çš„ä»£åƒ¹":Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" },Â 
Â  "æœ±ç ‚":Â  Â  Â  Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }Â Â 
};
// =================================================================
let localStorageKey = "mishi2025_v14";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });

let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const tm = t => parseInt(t.split(":")[0]) * 60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
Â  let res = [];
Â  for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
Â  return res;
}

// --- Google ç™»å…¥é‚è¼¯ (Redirect Mode) ---
let gisInited = false;

function gisInit() {
Â  Â  const userStatusEl = document.getElementById('user-status');
Â  Â  const signInButtonEl = document.getElementById('google-signin-button');

Â  Â  // 1. æª¢æŸ¥ç¶²å€åˆ—æ˜¯å¦åŒ…å« Google å°å›çš„ Token
Â  Â  const urlParams = new URLSearchParams(window.location.hash.substring(1));
Â  Â  const accessToken = urlParams.get('access_token');

Â  Â  if (accessToken) {
Â  Â  Â  Â  // ç™»å…¥æˆåŠŸï¼Œå„²å­˜ Token ä¸¦æ¸…ç†ç¶²å€åˆ—
Â  Â  Â  Â  sessionStorage.setItem('google_access_token', accessToken);
Â  Â  Â  Â  history.replaceState(null, null, window.location.pathname);Â 
Â  Â  }

Â  Â  // 2. æª¢æŸ¥æ˜¯å¦æœ‰ Token
Â  Â  if (sessionStorage.getItem('google_access_token')) {
Â  Â  Â  Â  userStatusEl.innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
Â  Â  Â  Â  signInButtonEl.style.display = 'none';
Â  Â  Â  Â  render(true);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. åˆå§‹åŒ– Google é‡æ–°å°å‘ç™»å…¥è¨­å®š
Â  Â  window.google.accounts.id.initialize({
Â  Â  Â  Â  client_id: CLIENT_ID,
Â  Â  Â  Â  callback: null, // Redirect æ¨¡å¼ä¸ä½¿ç”¨ callback
Â  Â  Â  Â  flow: 'implicit',
Â  Â  Â  Â  ux_mode: 'redirect', // å¼·åˆ¶ä½¿ç”¨é‡æ–°å°å‘æ¨¡å¼
Â  Â  Â  Â  redirect_uri: window.location.origin + '/booking-system/',Â 
Â  Â  Â  Â  scope: SCOPE
Â  Â  });
Â  Â Â 
Â  Â  // 4. æ¸²æŸ“ç™»å…¥æŒ‰éˆ•
Â  Â  userStatusEl.innerHTML = 'âš ï¸ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google é€²è¡ŒåŒæ­¥ã€‚';
Â  Â  signInButtonEl.style.display = 'block';
Â  Â Â 
Â  Â  window.google.accounts.id.renderButton(
Â  Â  Â  Â  signInButtonEl,
Â  Â  Â  Â  { theme: 'outline', size: 'large', type: 'standard', text: 'signin_with' }
Â  Â  );

Â  Â  gisInited = true;
Â  Â  render(false); // æœªç™»å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“æœ¬åœ°è³‡æ–™
}

// -------------------------------------------------------------------
// æ ¸å¿ƒæ•¸æ“šè®€å– (å‘¼å« GAS)
// -------------------------------------------------------------------

async function fetchCalendarBookings(gasUrl) {
Â  Â  const statusEl = document.getElementById('status-message');
Â  Â  const token = sessionStorage.getItem('google_access_token');
Â  Â Â 
Â  Â  if (!token) {
Â  Â  Â  Â  statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Googleã€‚ç„¡æ³•åŒæ­¥æ—¥æ›†ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#f39c12';
Â  Â  Â  Â  return {};Â 
Â  Â  }
Â  Â Â 
Â  Â  statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨ä½¿ç”¨æ‚¨çš„æ†‘è­‰å‘æ—¥æ›†ä¼ºæœå™¨è«‹æ±‚è³‡æ–™...';
Â  Â  statusEl.style.backgroundColor = '#3498db';

Â  Â  try {
Â  Â  Â  Â  const fetchUrl = `${gasUrl}?token=${token}`;Â 
Â  Â  Â  Â  const response = await fetch(fetchUrl);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) { 
Â  Â  Â  Â  Â  throw new Error(`ç¶²è·¯éŒ¯èª¤ ${response.status} (${response.statusText})`); 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const calendarEvents = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æª¢æŸ¥ GAS è¿”å›çš„è‡ªè¨‚éŒ¯èª¤
Â  Â  Â  Â  if (calendarEvents.error) {
Â  Â  Â  Â  Â  Â  if (calendarEvents.error === "TOKEN_INVALID" || calendarEvents.error === "API_ERROR") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥æ†‘è­‰ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€ï¼';
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('google_access_token'); 
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `è«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€é‡æ–°é–‹å§‹ç™»å…¥ã€‚éŒ¯èª¤: ${calendarEvents.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#e74c3c';
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Auth/API Failed");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `ğŸ›‘ GAS ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤: ${calendarEvents.message || 'æœªçŸ¥'}`;
Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#e74c3c';
Â  Â  Â  Â  Â  Â  throw new Error("EXECUTION_FAILED");
Â  Â  Â  Â  }


Â  Â  Â  Â  // æˆæ¬ŠæˆåŠŸ
Â  Â  Â  Â  statusEl.innerHTML = 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå·²åŒæ­¥æ‚¨çš„æ—¥æ›†äº‹ä»¶ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#2ecc71';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è™•ç†äº‹ä»¶
Â  Â  Â  Â  let tempExternalBookings = {};
Â  Â  Â  Â  Object.keys(CONFIG).forEach(k => tempExternalBookings[k] = []);
Â  Â  Â  Â  calendarEvents.forEach(event => {
Â  Â  Â  Â  Â  Â  if (CONFIG[event.theme] && event.time) {
Â  Â  Â  Â  Â  Â  Â  Â  tempExternalBookings[event.theme].push(event.time);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return tempExternalBookings;


Â  Â  } catch (error) {
Â  Â  Â  Â  if (!["Auth/API Failed", "EXECUTION_FAILED"].includes(error.message)) {
Â  Â  Â  Â  Â  Â  Â statusEl.innerHTML = `<p style="color:white; font-weight:bold; margin: 0;">âš ï¸ è¼‰å…¥æ—¥æ›†è³‡æ–™å¤±æ•—ï¼</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color:#ecf0f1;">éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
Â  Â  Â  Â  Â  Â  Â statusEl.style.backgroundColor = '#95a5a6';
Â  Â  Â  Â  }
Â  Â  Â  Â  return {};Â 
Â  Â  }
}

// -------------------------------------------------------------------
// ç‹€æ…‹æª¢æŸ¥ã€åˆ‡æ›ã€ç¹ªè£½é‚è¼¯ (ä¿æŒä¸è®Š)
// -------------------------------------------------------------------

function getStatus(theme, tVal) {
Â  const conf = CONFIG[theme];
Â  const tStr = valToStr(tVal);
Â  if (externalBookings[theme] && externalBookings[theme].includes(tStr)) return 'external-booked';
Â  if (localBookings[theme].includes(tStr)) return 'booked';
Â  const mate = Object.keys(CONFIG).find(k => CONFIG[k].group === conf.group && k !== theme);
Â  if (combinedBookings[mate] && combinedBookings[mate].includes(tStr)) return 'lobby-clash';
Â  for (let startStr of combinedBookings[theme]) {
Â  Â  let s = tm(startStr);
Â  Â  let s_block = s - conf.block_before;
Â  Â  let e_block = s + conf.block_after;Â 
Â  Â  if (tVal >= s_block && tVal < e_block) return 'blocked';
Â  }
Â  return 'available';
}

function checkConflict(theme, tVal) {
Â  Â  const conf = CONFIG[theme];
Â  Â  const s_new_buffer = tVal - conf.block_before;
Â  Â  const e_new_buffer = tVal + conf.block_after;
Â  Â  return combinedBookings[theme].some(existStr => {
Â  Â  Â  const s_exist = tm(existStr);
Â  Â  Â  const s_exist_buffer = s_exist - conf.block_before;
Â  Â  Â  const e_exist_buffer = s_exist + conf.block_after;
Â  Â  Â  if (s_new_buffer < e_exist_buffer && e_new_buffer > s_exist_buffer) {
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  });
}

function toggle(theme, time) {
Â  const tVal = tm(time);
Â  if (externalBookings[theme] && externalBookings[theme].includes(time)) {
Â  Â  Â  console.warn("æ­¤ç‚ºæ—¥æ›†é ç´„ï¼Œè«‹è‡³ Google æ—¥æ›†ä¸Šä¿®æ”¹æˆ–åˆªé™¤ã€‚");
Â  Â  Â  return;Â 
Â  }
Â  const idx = localBookings[theme].indexOf(time);
Â  if (idx > -1) {
Â  Â  localBookings[theme].splice(idx,1);
Â  } else {
Â  Â  if (getStatus(theme, tVal) !== 'available') return;Â 
Â  Â  if (checkConflict(theme, tVal)) return;
Â  Â  localBookings[theme].push(time);
Â  }
Â  localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
Â  render(false);Â 
}

function clearAll() {
Â  Â  Object.keys(localBookings).forEach(key => localBookings[key] = []);
Â  Â  localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
Â  Â Â 
Â  Â  // æ¸…é™¤ sessionStorage ä¸­çš„ tokenï¼Œå¼·åˆ¶é‡æ–°ç™»å…¥
Â  Â  sessionStorage.removeItem('google_access_token');Â 
Â  Â  location.reload();Â 
}

function copyAvailableSlots(theme) {
Â  const element = document.getElementById(`remaining-${theme}`);
Â  const slotsText = element.querySelector('.slot-text').innerText;
Â  const textToCopy = `${theme}å‰©é¤˜å ´æ¬¡ï¼š${slotsText}`;
Â  if (navigator.clipboard && navigator.clipboard.writeText) {
Â  Â  navigator.clipboard.writeText(textToCopy)
Â  Â  Â  .then(() => {
Â  Â  Â  Â  const button = element.querySelector('.copy-button');
Â  Â  Â  Â  button.innerText = 'âœ… å·²è¤‡è£½';
Â  Â  Â  Â  setTimeout(() => button.innerText = 'ä¸€éµè¤‡è£½', 1500);
Â  Â  Â  })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  const button = element.querySelector('.copy-button');
Â  Â  Â  Â  button.innerText = 'è¤‡è£½å¤±æ•—';
Â  Â  Â  });
Â  } else {
Â  Â  const button = element.querySelector('.copy-button');
Â  Â  button.innerText = 'è¤‡è£½å¤±æ•— (è«‹æ‰‹å‹•)';
Â  }
}

async function render(shouldFetch = true) {
Â  Â  // æœªç™»å…¥ä¸”å°šæœªåˆå§‹åŒ–ï¼Œå‰‡é€²è¡Œåˆå§‹åŒ–æµç¨‹
Â  Â  if (!gisInited && !sessionStorage.getItem('google_access_token')) {Â 
Â  Â  Â  Â  gisInit();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  let fetchError = false;
Â  Â  if (shouldFetch && sessionStorage.getItem('google_access_token')) {
Â  Â  Â  Â  const fetchedEvents = await fetchCalendarBookings(GAS_URL);
Â  Â  Â  Â  externalBookings = fetchedEvents;
Â  Â  Â  Â  const statusEl = document.getElementById('status-message');
Â  Â  Â  Â  // æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡éŒ¯èª¤
Â  Â  Â  Â  if (statusEl.innerHTML.includes('âŒ') || statusEl.innerHTML.includes('ğŸ›‘') || statusEl.innerHTML.includes('âš ï¸')) {
Â  Â  Â  Â  Â  Â  fetchError = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // åˆä½µæœ¬åœ°é ç´„å’Œæ—¥æ›†é ç´„
Â  Â  combinedBookings = JSON.parse(JSON.stringify(localBookings));
Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  Â  if (externalBookings[theme]) {
Â  Â  Â  Â  Â  Â  externalBookings[theme].forEach(time => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!combinedBookings[theme].includes(time)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  combinedBookings[theme].push(time);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!combinedBookings[theme]) combinedBookings[theme] = [];Â 
Â  Â  });
Â  Â Â 
Â  Â  // éŒ¯èª¤è™•ç†é¡¯ç¤º
Â  Â  if (fetchError && shouldFetch) {
Â  Â  Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  Â  Â  Â  document.getElementById(CONFIG[theme].id).innerHTML = `<div style="color:#e74c3c; text-align:center; padding: 20px;">è«‹å…ˆè§£æ±ºä¸Šæ–¹æç¤ºçš„éŒ¯èª¤æˆ–ç™»å…¥ã€‚</div>`;
Â  Â  Â  Â  Â  Â  document.getElementById(`remaining-${theme}`).innerHTML = `<strong>å‰©é¤˜å ´æ¬¡ï¼š</strong><span class="slot-text" style="color:#e74c3c;">ç„¡æ³•åŒæ­¥</span><button class="copy-button" onclick="copyAvailableSlots('${theme}')">ä¸€éµè¤‡è£½</button>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // æ­£å¸¸æ¸²æŸ“æµç¨‹
Â  Â  const allTimes = {};
Â  Â Â 
Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  const conf = CONFIG[theme];
Â  Â  Â  const el = document.getElementById(conf.id);
Â  Â  Â  const times = generateTimes(conf.interval);
Â  Â  Â  let availableTimes = [];

Â  Â  Â  el.innerHTML = times.map(t => {
Â  Â  Â  Â  const tVal = tm(t);
Â  Â  Â  Â  const s = getStatus(theme, tVal);
Â  Â  Â  Â  let label = t;
Â  Â  Â  Â  let cls = s;
Â  Â  Â  Â  let onClick = `onclick="toggle('${theme}','${t}')"`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (s === 'booked') { }Â 
Â  Â  Â  Â  else if (s === 'external-booked') {
Â  Â  Â  Â  Â  cls = 'external-booked'; label = t + ' (æ—¥æ›†)'; onClick = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (s === 'lobby-clash') {Â 
Â  Â  Â  Â  Â  cls = 'lobby-clash'; label = 'é–‹å ´è¡çª'; onClick = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (s === 'blocked') {Â 
Â  Â  Â  Â  Â  const totalMinutes = conf.block_before + conf.block_after;
Â  Â  Â  Â  Â  label = `ä½”ç”¨ (${totalMinutes}åˆ†)`; onClick = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (checkConflict(theme, tVal)) {
Â  Â  Â  Â  Â  Â  Â  cls = 'blocked'; label = 'æ’ç¨‹è¡çª'; onClick = '';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  availableTimes.push(t);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return `<div class="slot ${cls}" ${onClick}>${label}</div>`;
Â  Â  Â  }).join('');
Â  Â  Â  allTimes[theme] = availableTimes;
Â  Â  });

Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  const areaEl = document.getElementById(`remaining-${theme}`);
Â  Â  Â  const availableSlots = allTimes[theme] || [];
Â  Â  Â  const slotsText = availableSlots.join(', ') || 'æœ¬æ—¥ç„¡å‰©é¤˜å ´æ¬¡';
Â  Â  Â  areaEl.innerHTML = `
Â  Â  Â  Â  <div style="display: flex; align-items: flex-start; width: 100%;">
Â  Â  Â  Â  Â  Â  <strong>å‰©é¤˜å ´æ¬¡ï¼š</strong>
Â  Â  Â  Â  Â  Â  <div class="slot-text-container">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="slot-text">${slotsText}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="copy-button" onclick="copyAvailableSlots('${theme}')">ä¸€éµè¤‡è£½</button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  });
}

// ç¢ºä¿é¦–æ¬¡è¼‰å…¥æ™‚åˆå§‹åŒ– Google ç™»å…¥
window.onload = gisInit;
</script>
</body>
</html>