<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>謎失工作室 排程同步系統（V48 最終版 - 修正缺席日曆 ID）</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    /* 樣式部分保持與 V47 相同 */
    body { 
        font-family: 'Noto Sans TC', sans-serif; 
        background:#f0f4f8; 
        color:#2c3e50; 
        padding:20px; 
        margin:0; 
        line-height:1.6; 
        padding-bottom: 100px; 
    }
    h1 { text-align:center; margin:20px 0 10px; font-size:2.2em; color:#34495e; }
    #auth-container { text-align:center; margin-bottom:25px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    #user-status { margin:5px 0 15px; font-size:1.1em; color:#2980b9; font-weight:500; }
    #status-message { text-align:center; margin-bottom:20px; padding:12px; border-radius:8px; color:white; font-weight:bold; 
        font-size: 1.1em;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }
    #absence-alert { display: none; }

    #top-controls { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        margin-bottom: 20px; 
        gap: 15px; 
    }
    #date-picker-container {
        display: flex;
        gap: 10px;
        align-items: center;
        font-weight: 500;
        font-size: 1.1em;
        padding: 10px 0;
    }
    
    .container { display:flex; flex-wrap:wrap; justify-content:center; gap:25px; }
    .theme { background:#fff; padding:20px; border-radius:12px; width:100%; max-width:650px; box-shadow:0 6px 15px rgba(0,0,0,0.1); border-top:5px solid #3498db; }
    .theme h2 { text-align:center; background:#ecf0f1; padding:12px; border-radius:8px; margin:0 0 20px; font-size:1.5em; color:#34495e; }
    .slots { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; }
    
    .slot { 
        padding:5px 5px; 
        text-align:center; 
        border-radius:6px; 
        font-weight:500; 
        font-size:0.9em; 
        user-select:none; 
        line-height:1.2; 
        transition:all 0.15s; 
        cursor:default;
        
        /* 確保兩行文字的空間與置中 */
        height: 40px; 
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .available { background:#2ecc71; color:white; cursor:pointer; }
    .available:hover { background:#27ae60; transform:translateY(-1px); }
    .booked { background:#e74c3c; color:white; cursor:pointer; }
    .booked:hover { background:#c0392b; transform:translateY(-1px); }

    .blocked { background:#bdc3c7; color:#7f8c8d; cursor:not-allowed; opacity:0.8; }
    .lobby-clash { background:#9b59b6; color:white; cursor:not-allowed; }
    .external-booked { background:#f39c12; color:white; font-weight:700; cursor:not-allowed; }
    /* 已過期時段 */
    .past-time { background:#a0a0a0; color:white; cursor:not-allowed; opacity:0.6; } 
    .hidden-past { display: none !important; } 
    
    .available-slots-area { margin-top:25px; padding:15px; background:#f8f9fa; border-radius:8px; }
    .available-slots-area strong { display:block; margin-bottom:8px; color:#e67e22; font-weight:700; }
    .copy-button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
    .copy-button:hover { background:#2980b9; }
    
    #controls { position:fixed; bottom:20px; right:20px; display:flex; gap:10px; z-index:999; }
    #controls button { padding:12px 20px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    #clear-manual { background:#95a5a6; } 
    #hide-past-btn { background:#bdc3c7; } 
    #hide-past-btn.active { background:#3498db; }
    #copy-all { background:#8e44ad; }
    #copy-all:hover { background:#6d3588; }
    
    #filter-controls { text-align:center; font-weight:500; font-size:1.1em; color:#34495e; display: flex; justify-content: center; gap: 15px; }
    #filter-controls button { padding:10px 18px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
    #override { background:#ff9f43; } 
    #override.active { background:#c0392b; }
    #clear { background:#e74c3c; }

    .legend { display: none; } 

    /* 右鍵選單樣式 */
    .context-menu {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        padding: 5px 0;
        z-index: 1000;
        min-width: 120px;
    }
    .context-menu button {
        display: block;
        width: 100%;
        padding: 8px 15px;
        border: none;
        background: none;
        text-align: left;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        color: #34495e;
    }
    .context-menu button:hover {
        background-color: #f0f0f0;
    }
    .context-menu button.force-book {
        color: #c0392b;
        font-weight: 700;
    }
</style>
</head>
<body>
<h1>謎失工作室 排程同步系統</h1>

<div id="auth-container">
    <p id="user-status">載入中...</p>
    <div id="google-signin-button"></div>
</div>
<div id="status-message" style="background:#bdc3c7;">載入中...</div>

<div id="top-controls">
    <div id="date-picker-container">
        查詢日期：
        <input type="date" id="calendar-date" onchange="render(true)" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
    </div>
    <div id="absence-alert"></div> 
</div>

<div id="filter-controls">
    <button id="override" onclick="toggleOverrideMode()">開放模式</button>
    <button id="clear" onclick="clearAll()">登出重製</button>
</div>

<div class="container">
    <div class="theme"><h2>301號房</h2><div class="slots" id="s1"></div><div id="remaining-301號房" class="available-slots-area"></div></div>
    <div class="theme"><h2>失物招領</h2><div class="slots" id="s2"></div><div id="remaining-失物招領" class="available-slots-area"></div></div>
    <div class="theme"><h2>藝樣的代價</h2><div class="slots" id="s3"></div><div id="remaining-藝樣的代價" class="available-slots-area"></div></div>
    <div class="theme"><h2>朱砂</h2><div class="slots" id="s4"></div><div id="remaining-朱砂" class="available-slots-area"></div></div>
</div>

<div id="controls">
    <button id="clear-manual" onclick="clearManualBookings()">取消手動</button>
    <button id="hide-past-btn" onclick="toggleHidePastSlots()">隱藏已過時間 (開)</button>
    <button id="copy-all" onclick="copyAllAvailableSlots()">全部複製</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ================== 設定區 (V48 最終穩定版 - 修正缺席日曆 ID) ==================
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
const ABSENCE_KEYWORDS = ["邱不在", "鈺晴不在"]; 
// ✅ V48 修正: 修正了缺席日曆 ID，加入了 .google
const ABSENCE_CALENDAR_ID = '0aee774d72e9f3b5eb1098f54c2285dadd336dfa0b8b265be09f46a94a3644a4@group.calendar.google.com';
const PRIMARY_CALENDAR_ID = 'primary'; 

// V48 邏輯：與 V13 邏輯相同
// 1. block_before = 0 維持緊密接續 
// 2. block_after = 0 (無清理時間)
const CONFIG = {
    // 90分鐘遊戲時長，預約前佔用 0 分鐘，預約後佔用 0 分鐘
    "301號房":      { dur: 90,  group: "館A", interval: 15, block_before: 0, block_after: 0, id: "s1", store: "山子頂店" }, 
    "失物招領":    { dur: 90,  group: "館A", interval: 15, block_before: 0, block_after: 0, id: "s2", store: "山子頂店" }, 
    // 150分鐘遊戲時長，預約前佔用 0 分鐘，預約後佔用 0 分鐘
    "藝樣的代價": { dur: 150, group: "館B", interval: 30, block_before: 0, block_after: 0, id: "s3", store: "中壢店" }, 
    "朱砂":        { dur: 150, group: "館B", interval: 30, block_before: 0, block_after: 0, id: "s4", store: "中壢店" }
};

let localStorageKey = "mishi2025_final";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
let externalBookings = {};
let hidePastSlots = localStorage.getItem('hidePastSlots') !== 'false'; 
let overrideMode = localStorage.getItem('overrideMode') === 'true'; 
let selectedDate = new Date(); 
let longPressTimer = null; 
let mouseDownTime = 0; 
let contextMenuOpen = false; 

// ================== 工具函式 ==================

const tm = t => parseInt(t.split(":")[0])*60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(Math.floor(v%60)).padStart(2,'0')}`; 
const getCurrentMinutes = () => {
    const today = new Date();
    if (selectedDate.toDateString() !== today.toDateString()) {
        return -1; 
    }
    return today.getHours() * 60 + today.getMinutes();
}
const formatDate = (date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}
function generateTimes(interval) {
    let res = [];
    for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
    return res;
}

// ================== Google Identity Service & Calendar API 函式 ==================

function initGoogleSignIn() {
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse, auto_select: false });
    google.accounts.id.renderButton(document.getElementById("google-signin-button"), { theme: "outline", size: "large" });
    document.getElementById('user-status').innerHTML = '請點下方按鈕登入 Google 以同步日曆';
    
    document.getElementById('calendar-date').value = formatDate(selectedDate);
}

function handleCredentialResponse(response) {
    google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPE, callback: (resp) => {
            if (resp.error) { 
                alert("登入失敗，請嘗試使用「登出重製」後再試一次：" + resp.error); 
                return; 
            }
            sessionStorage.setItem('google_access_token', resp.access_token);
            document.getElementById('user-status').innerHTML = '已登入，正在讀取日曆...';
            document.getElementById('google-signin-button').style.display = 'none';
            render(true);
        }
    }).requestAccessToken();
}

async function fetchCalendarBookings() {
    const token = sessionStorage.getItem('google_access_token');
    const statusEl = document.getElementById('status-message');
    const absenceAlertEl = document.getElementById('absence-alert');
    if (!token) return {};

    const dateInput = document.getElementById('calendar-date').value;
    if (!dateInput) return {}; 

    const dateParts = dateInput.split('-');
    selectedDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

    const timeMin = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()).toISOString();
    const timeMax = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate()+1).toISOString();

    statusEl.innerHTML = `正在讀取 ${dateInput} 的 Google 日曆...`; 
    statusEl.style.backgroundColor = '#3498db';

    const calendarIds = [PRIMARY_CALENDAR_ID];
    if (ABSENCE_CALENDAR_ID && ABSENCE_CALENDAR_ID !== PRIMARY_CALENDAR_ID) {
        calendarIds.push(ABSENCE_CALENDAR_ID);
    }
    
    let allEvents = [];
    const ext = {};
    Object.keys(CONFIG).forEach(k => ext[k] = []);
    const absentStaff = new Set(); 
    let calendarError = null; 

    try {
        for (const calId of calendarIds) {
            try { 
                const res = await fetch(
                    `https://www.googleapis.com/calendar/v3/calendars/${calId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`,
                    { headers: { Authorization: `Bearer ${token}` } }
                );

                if (!res.ok) {
                    throw new Error(`API ${res.status} for calendar: ${calId}`);
                }

                const data = await res.json();
                allEvents = allEvents.concat(data.items);
            } catch (err) {
                // 如果失敗的是非主要日曆 (缺席日曆)，則記錄錯誤並跳過它，繼續執行主要日曆。
                if (calId === ABSENCE_CALENDAR_ID) {
                    console.error(`ABSENCE CALENDAR READ FAILED: ${err.message}`);
                    calendarError = "缺席日曆讀取失敗 (404/權限不足)，請檢查 ID。";
                    continue; 
                } else {
                    // 如果是主要日曆 (primary) 失敗，則拋出錯誤，讓外部 catch 停止整個程序。
                    throw err; 
                }
            }
        }
        
        allEvents.forEach(item => {
            if (!item.summary) return;

            ABSENCE_KEYWORDS.forEach(keyword => {
                if (item.summary.includes(keyword)) {
                    const staffName = keyword.replace('不在', '');
                    absentStaff.add(staffName);
                }
            });

            if (item.start?.dateTime) {
                const start = new Date(item.start.dateTime);
                const timeStr = `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')}`;
                
                Object.keys(CONFIG).forEach(theme => {
                    if (item.summary.includes(theme)) {
                        ext[theme].push(timeStr);
                    }
                });
            }
        });

        let statusMessage = '日曆同步完成！';
        
        if (calendarError) {
             statusMessage = `日曆同步完成！ ⚠️ ${calendarError}`;
             statusEl.style.backgroundColor = '#ff9f43'; // 橘色警告
        } else {
             statusEl.style.backgroundColor = '#2ecc71';
        }

        if (absentStaff.size > 0) {
            statusMessage += ` ⚠️ **${Array.from(absentStaff).join(' 和 ')} 不在場**`;
        }

        statusEl.innerHTML = statusMessage; 
        absenceAlertEl.style.display = 'none';

        return ext;

    } catch (err) {
        // 外部 catch 僅處理主要日曆或其他嚴重錯誤
        statusEl.innerHTML = `日曆讀取失敗：${err.message}`; 
        statusEl.style.backgroundColor = '#e74c3c';
        absenceAlertEl.style.display = 'none';
        console.error(err);
        return {};
    }
}


// ================== 時段狀態計算 (V13 衝突邏輯) ==================

function calculateSlotStatus(theme, timeStr) {
    const cfg = CONFIG[theme];
    const cur = tm(timeStr);
    const dur = cfg.dur;
    
    // 優先權 1: 檢查「可預約覆蓋」(綠色)
    if (localBookings[theme][timeStr] === 'available_override') return 'available';

    // 優先權 2: 檢查手動/強制預約 (紅色)
    if (localBookings[theme][timeStr]) return 'booked'; 

    let isBlocked = false;
    let isLobbyClash = false;
    
    // 建立 combinedTimes 陣列 (用於衝突檢查，只考慮真正的 booking)
    const allBookingsForClashCheck = {};
    Object.keys(CONFIG).forEach(k => {
        
        // 只考慮真正的 local booking (manual, force)
        const trueLocalTimes = Object.keys(localBookings[k] || {}).filter(t => 
            localBookings[k][t] === 'manual' || localBookings[k][t] === 'force'
        );
        
        let combinedTimes = trueLocalTimes;

        if (!overrideMode) {
            combinedTimes = combinedTimes.concat(externalBookings[k] || []);
        }
        allBookingsForClashCheck[k] = combinedTimes;
    });


    // 優先權 3: 檢查外部預約 (只在非 override 模式下)
    if (!overrideMode) {
        if (externalBookings[theme]?.includes(timeStr)) return 'external-booked';
    }

    // 檢查主題內部佔用/館別衝突
    Object.keys(CONFIG).forEach(otherTheme => {
        const otherConfig = CONFIG[otherTheme];
        
        allBookingsForClashCheck[otherTheme].forEach(bookedTimeStr => {
            const bookedTime = tm(bookedTimeStr);
            
            // 檢查館別衝突 (Lobby Clash - 紫色) - 採用 V13 的嚴格相同時間點衝突邏輯
            if (cfg.group === otherConfig.group && theme !== otherTheme) {
                // V13 邏輯：只有當前時段的起始時間與被預約時段的起始時間完全相同時才衝突
                if (cur === bookedTime) {
                    isLobbyClash = true;
                }
            }

            // 檢查主題內部佔用 (Blocked - 灰色) - 確保同一主題的預約不會衝突
            if (theme === otherTheme) {
                // V48/V13: block_before = 0， block_after = 0
                const lockStartTime = bookedTime - otherConfig.block_before;
                const lockEndTime = bookedTime + otherConfig.dur + otherConfig.block_after;

                const slotStartTime = cur;
                const slotEndTime = cur + dur;
                
                // 檢查兩個時段是否有重疊
                const overlap = Math.max(0, Math.min(slotEndTime, lockEndTime) - Math.max(slotStartTime, lockStartTime));

                if (overlap > 0) {
                    isBlocked = true;
                }
            }
        });
    });

    if (isLobbyClash) return 'lobby-clash'; 
    if (isBlocked) return 'blocked';
    
    // 如果沒有任何衝突，才是真正的 available (綠色)
    return 'available';
}


// ================== 視覺渲染與操作 ==================

function toggleForcedState(theme, time) { 
    
    const currentState = localBookings[theme][time];

    if (currentState === 'available_override') {
        delete localBookings[theme][time];
    } else {
        localBookings[theme][time] = 'available_override'; 
    }

    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    
    requestAnimationFrame(() => {
        render(false); 
    });
}

function cancelBooking(theme, time) {
    delete localBookings[theme][time];
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    
    requestAnimationFrame(() => {
        render(false); 
    });
}


function toggleSlot(theme, time, el) {
    if (contextMenuOpen) return; 

    const slotMinutes = tm(time);
    const currentMinutes = getCurrentMinutes();
    const isPast = (currentMinutes !== -1 && slotMinutes < currentMinutes);
    const status = calculateSlotStatus(theme, time);
    
    if (isPast && !overrideMode) { 
        alert("此時段已過期。非開放模式下無法點擊過去時間。");
        return; 
    }
    
    if (status === 'blocked' || status === 'lobby-clash' || status === 'external-booked') {
         alert("此時段已被鎖定 (佔用/衝突/日曆已訂)，單點無法預約。請使用**右鍵/長按選單**中的「設為可預約狀態 (綠色)」進行覆蓋。");
         return; 
    }
    
    if (localBookings[theme][time] === 'available_override') {
        toggleForcedState(theme, time); 
        return; 
    }
    
    let isBooking = !localBookings[theme][time]; 

    if (isBooking) {
        localBookings[theme][time] = 'manual'; 
        el.className = 'slot booked'; 
        el.innerHTML = time + '<br>(已預約)';
    } else {
        delete localBookings[theme][time]; 
        el.className = 'slot available'; 
        el.innerHTML = time;
    }
    
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    
    requestAnimationFrame(() => {
        render(false); 
    }); 
}

function handleSlotContext(event, theme, time, el) {
    event.preventDefault(); 
    event.stopPropagation();
    contextMenuOpen = true; 

    closeContextMenu(); 

    const menu = document.createElement('div');
    menu.className = 'context-menu';
    
    const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
    const clientY = event.touches ? event.touches[0].clientY : event.clientY;
    
    menu.style.left = `${clientX + window.scrollX}px`;
    menu.style.top = `${clientY + window.scrollY}px`;

    const currentBookingType = localBookings[theme][time];
    
    let buttonText;
    let buttonClass = '';
    let actionFunction;
    
    if (currentBookingType === 'available_override') {
        buttonText = '❌ 取消可預約覆蓋';
        actionFunction = () => cancelBooking(theme, time); 
    } else if (currentBookingType === 'manual' || currentBookingType === 'force') {
         buttonText = '✅ 取消手動/強制預約';
         actionFunction = () => cancelBooking(theme, time);
    } else {
        buttonText = '✅ 設為可預約狀態 (綠色)';
        buttonClass = 'force-book'; 
        actionFunction = () => toggleForcedState(theme, time); 
    }
    
    
    const forceBtn = document.createElement('button');
    forceBtn.innerHTML = buttonText;
    forceBtn.className = buttonClass;
    
    forceBtn.onclick = (e) => {
        e.stopPropagation();
        // 確保點擊行為正確執行
        if (actionFunction === toggleForcedState && localBookings[theme][time] !== 'available_override') {
             localBookings[theme][time] = 'available_override'; 
        } else {
             actionFunction();
        }
        closeContextMenu(); 
        render(false); 
    };
    menu.appendChild(forceBtn);

    document.body.appendChild(menu);

    setTimeout(() => {
        document.addEventListener('click', closeContextMenu);
        document.addEventListener('touchend', closeContextMenu);
        document.addEventListener('mouseup', closeContextMenu); 
    }, 100); 
}

function renderSlots(doPastTimeCheck = true) {
    // 檢查是否為當天，並計算目前的分鐘數
    const currentMinutes = doPastTimeCheck ? getCurrentMinutes() : -1;

    const hidePastButton = document.getElementById('hide-past-btn');
    if (hidePastSlots) {
        hidePastButton.classList.add('active');
        hidePastButton.innerHTML = '隱藏已過時間 (開)';
    } else {
        hidePastButton.classList.remove('active');
        hidePastButton.innerHTML = '顯示已過時間 (關)';
    }

    Object.keys(CONFIG).forEach(theme => {
        const {id, interval} = CONFIG[theme];
        const times = generateTimes(interval);
        
        let html = '';
        times.forEach(t => {
            const slotMinutes = tm(t);
            // 只有當 currentMinutes 不為 -1 (當天) 且時段早於現在時才判定為 isPast
            const isPast = (currentMinutes !== -1 && slotMinutes < currentMinutes); 

            let status = calculateSlotStatus(theme, t);
            let label = t;
            let slotClass = status;

            if (status === 'booked') {
                const bookingType = localBookings[theme][t]; 
                if (bookingType === 'force') {
                    label += '<br>(強制預約)';
                } else if (bookingType === 'manual') {
                    label += '<br>(已預約)'; 
                }
            }
            else if (status === 'available') {
                if (localBookings[theme][t] === 'available_override') {
                    label += '<br>(強制可約)';
                }
            }
            
            if (!overrideMode && isPast) { 
                slotClass = 'past-time';
                if (hidePastSlots) { 
                    slotClass += ' hidden-past';
                }
            }
            else if (status === 'blocked') {
                label += '<br>(佔用)';
            } else if (status === 'lobby-clash') {
                label += '<br>(衝突)';
            } else if (status === 'external-booked') {
                label += '<br>(日曆已訂)';
            }
            
            html += `<div class="slot ${slotClass}" 
                        onclick="if((Date.now() - mouseDownTime) < 500 && !contextMenuOpen) { toggleSlot('${theme}','${t}',this); }" 
                        onmousedown="mouseDown(event, '${theme}', '${t}', this)"
                        onmouseup="mouseUp(event, '${theme}', '${t}', this)"
                        oncontextmenu="handleSlotContext(event, '${theme}', '${t}', this)" 
                        ontouchstart="longPressStart(event, '${theme}', '${t}', this)" 
                        ontouchend="longPressEnd(event, '${theme}', '${t}', this)" 
                        ontouchmove="longPressCancel()"
                        data-theme="${theme}" data-time="${t}">
                        ${label}
                    </div>`;
        });
        document.getElementById(id).innerHTML = html;
    });
    updateRemainingSlotsDisplay();
}

function closeContextMenu() {
    document.querySelectorAll('.context-menu').forEach(menu => menu.remove());
    contextMenuOpen = false;
    document.removeEventListener('click', closeContextMenu);
    document.removeEventListener('touchend', closeContextMenu);
    document.removeEventListener('mouseup', closeContextMenu); 
}

function toggleHidePastSlots() {
    hidePastSlots = !hidePastSlots;
    localStorage.setItem('hidePastSlots', hidePastSlots ? 'true' : 'false'); 
    
    // 確保呼叫 renderSlots 時會重新計算目前時間 (doPastTimeCheck 預設為 true)
    renderSlots(); 
}

function mouseDown(event, theme, time, el) {
    if (event.button === 0) { 
        mouseDownTime = Date.now();
        if (!contextMenuOpen) {
            longPressTimer = setTimeout(() => {
                if (Date.now() - mouseDownTime >= 500) {
                    el.dataset.preventClick = 'true'; 
                    handleSlotContext(event, theme, time, el);
                }
            }, 500);
        }
    }
}

function mouseUp(event, theme, time, el) {
    if (event.button === 0) { 
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        if ((Date.now() - mouseDownTime) < 500) {
            el.dataset.preventClick = 'false';
        }
    }
}

function longPressStart(event, theme, time, el) {
    longPressCancel();
    mouseDownTime = Date.now(); 
    
    el.dataset.isLongPress = 'false';

    longPressTimer = setTimeout(() => {
        if (Date.now() - mouseDownTime >= 500) {
             el.dataset.isLongPress = 'true';
             handleSlotContext(event, theme, time, el);
        }
    }, 500); 
}

function longPressEnd(event, theme, time, el) {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    
    if (el.dataset.isLongPress === 'true') {
        event.preventDefault(); 
    }
}

function longPressCancel() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
    document.querySelectorAll('.slot').forEach(el => {
        el.dataset.isLongPress = 'false';
        el.dataset.preventClick = 'false';
    });
}

function toggleOverrideMode() {
    const button = document.getElementById('override');
    overrideMode = !overrideMode;
    
    localStorage.setItem('overrideMode', overrideMode ? 'true' : 'false');

    if (overrideMode) {
        button.classList.add('active');
        button.innerHTML = '✅ 開放模式 (已啟用)';
        document.getElementById('status-message').style.backgroundColor = '#c0392b';
        document.getElementById('status-message').innerHTML = '日曆同步完成！ ⚠️ **開放模式已啟用**。';

    } else {
        button.classList.remove('active');
        button.innerHTML = '開放模式';
        document.getElementById('status-message').style.backgroundColor = '#2ecc71';
        document.getElementById('status-message').innerHTML = '日曆同步完成！';
    }
    
    // 確保切換模式時也重新渲染，並且要檢查過去時間
    render(false); 
}

function clearManualBookings() {
    if (confirm("確定要取消所有【手動預約】、【強制預約】與【可預約覆蓋】 (紅色/綠色覆蓋) 並重新整理頁面嗎？這將會同步日曆新資料。")) {
        let emptyBookings = {};
        Object.keys(CONFIG).forEach(k => { emptyBookings[k] = {}; }); 
        localBookings = emptyBookings;
        localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
        location.reload(); 
    }
}

function updateRemainingSlotsDisplay() {
    const currentMinutes = getCurrentMinutes();
    const isOverride = overrideMode;

    Object.keys(CONFIG).forEach(theme => {
        const area = document.getElementById(`remaining-${theme}`);
        const times = generateTimes(CONFIG[theme].interval);
        
        const avail = times.filter(t => {
            const slotMinutes = tm(t);
            const isPast = (currentMinutes !== -1 && slotMinutes < currentMinutes);
            const status = calculateSlotStatus(theme, t);
            
            if (isOverride) {
                // 在開放模式下，只要不是手動/強制預約、內部佔用、館別衝突，就算可用
                return status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash';
            } else {
                // 在正常模式下，只有完全 available 且不是過去時間才算可用
                return !isPast && status === 'available';
            }
        });

        const text = avail.length ? avail.join(', ') : (isOverride ? '所有可開時段皆已被強制預約/衝突鎖定' : '當日無空檔');
        
        const full = `${theme}: ${avail.join(', ')}`;

        area.innerHTML = `<strong>${theme} 可預約 (${avail.length}檔)${isOverride ? ' [開放模式]' : ''}：</strong>
            <div style="margin:8px 0; word-break:break-all;">${text.length>200 ? avail.slice(0,15).join(', ')+'...' : text}</div>
            <button class="copy-button" onclick="navigator.clipboard.writeText('${full}').then(()=>alert('已複製 ${theme} 可預約時間！'))">複製本欄</button>`;
    });
}

function copyAllAvailableSlots() {
    const currentMinutes = getCurrentMinutes();
    const isOverride = overrideMode;
    
    let allSlotsData = {}; 

    Object.keys(CONFIG).forEach(theme => {
        const { store, interval } = CONFIG[theme];
        const times = generateTimes(interval);
        
        const avail = times.filter(t => {
            const slotMinutes = tm(t);
            const isPast = (currentMinutes !== -1 && slotMinutes < currentMinutes);
            const status = calculateSlotStatus(theme, t);
            
            if (isOverride) {
                return status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash';
            } else {
                return !isPast && status === 'available';
            }
        });

        if (!allSlotsData[store]) {
            allSlotsData[store] = {};
        }
        allSlotsData[store][theme] = avail;
    });

    const formattedDate = formatDate(selectedDate);
    let outputText = `【${formattedDate} 剩餘場次】\n\n`; 
    let hasAvailable = false;

    const storeOrder = ["中壢店", "山子頂店"];
    const themeOrder = Object.keys(CONFIG);

    storeOrder.forEach(storeName => {
        outputText += `${storeName}\n`;
        
        themeOrder.forEach(theme => {
             if (CONFIG[theme].store === storeName) {
                const avail = allSlotsData[storeName][theme] || [];
                const timeStr = avail.length ? avail.join(', ') : '當日無空檔';

                outputText += `${theme}: ${timeStr}\n`;
                if (avail.length > 0) hasAvailable = true;
             }
        });
        outputText += "\n";
    });

    const modeAlert = isOverride ? `⚠️ 注意：複製的是【開放模式】下所有時段，不含內部衝突鎖定。\n` : ``;
    outputText = modeAlert + outputText.trim();


    navigator.clipboard.writeText(outputText).then(() => {
        alert('所有主題的剩餘可預約時間已複製到剪貼簿！');
    }).catch(err => {
        console.error('複製失敗:', err);
        alert('複製失敗，請手動複製。');
    });
}

async function render(doFetch = true) {
    if (doFetch) externalBookings = await fetchCalendarBookings();
    renderSlots();
    updateRemainingSlotsDisplay();
}

function clearAll() {
    sessionStorage.clear();
    localStorage.removeItem(localStorageKey);
    localStorage.removeItem('hidePastSlots'); 
    localStorage.removeItem('overrideMode'); 
    location.reload();
}

// 初始載入
window.onload = () => {
    // 確保 localBookings 結構為 Object (支援 override 功能)
    Object.keys(CONFIG).forEach(k => { 
        if (!localBookings[k]) {
             localBookings[k] = {};
        } else if (Array.isArray(localBookings[k])) {
            // 舊版本 Array 轉換為新版本 Object
            const oldArray = localBookings[k];
            localBookings[k] = {};
            oldArray.forEach(time => {
                localBookings[k][time] = 'manual'; 
            });
        }
    });
    
    initGoogleSignIn();
    
    if (sessionStorage.getItem('google_access_token')) {
        document.getElementById('user-status').innerHTML = '已登入，讀取日曆中...';
        document.getElementById('google-signin-button').style.display = 'none';
        render(true);
    } else {
        document.getElementById('status-message').innerHTML = '尚未登入日曆，資料可能不完整。';
        document.getElementById('status-message').style.backgroundColor = '#bdc3c7';
        render(false); 
    }
    
    const hidePastButton = document.getElementById('hide-past-btn');
    if (hidePastSlots) {
        hidePastButton.classList.add('active');
        hidePastButton.innerHTML = '隱藏已過時間 (開)';
    } else {
        hidePastButton.classList.remove('active');
        hidePastButton.innerHTML = '顯示已過時間 (關)';
    }
    
    const overrideButton = document.getElementById('override');
    if (overrideMode) {
        overrideButton.classList.add('active');
        overrideButton.innerHTML = '✅ 開放模式 (已啟用)';
        
        const statusEl = document.getElementById('status-message');
        statusEl.style.backgroundColor = '#c0392b';
        if (!sessionStorage.getItem('google_access_token')) {
             statusEl.innerHTML = '⚠️ **已啟用開放模式**：忽略 Google 日曆預約與已過時間，保留館內衝突。';
        } else {
             statusEl.innerHTML = '日曆同步完成！ ⚠️ **開放模式已啟用**。';
        }
    } else {
        overrideButton.classList.remove('active');
        overrideButton.innerHTML = '開放模式';
        // 確保非開放模式下顯示綠色狀態訊息
        if (sessionStorage.getItem('google_access_token')) {
            document.getElementById('status-message').style.backgroundColor = '#2ecc71';
            document.getElementById('status-message').innerHTML = '日曆同步完成！';
        }
    }
};
</script>
</body>
</html>