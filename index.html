<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±ï¼ˆæœ€çµ‚ç‰ˆ - è¤‡è£½æ ¼å¼ä¿®æ­£ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Noto Sans TC', sans-serif; background:#f0f4f8; color:#2c3e50; padding:20px; margin:0; line-height:1.6; }
    h1 { text-align:center; margin:20px 0 10px; font-size:2.2em; color:#34495e; }
    #auth-container { text-align:center; margin-bottom:25px; padding:15px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
    #user-status { margin:5px 0 15px; font-size:1.1em; color:#2980b9; font-weight:500; }
    #status-message { text-align:center; margin-bottom:20px; padding:12px; border-radius:8px; color:white; font-weight:bold; }
    .container { display:flex; flex-wrap:wrap; justify-content:center; gap:25px; }
    .theme { background:#fff; padding:20px; border-radius:12px; width:100%; max-width:650px; box-shadow:0 6px 15px rgba(0,0,0,0.1); border-top:5px solid #3498db; }
    .theme h2 { text-align:center; background:#ecf0f1; padding:12px; border-radius:8px; margin:0 0 20px; font-size:1.5em; color:#34495e; }
    .slots { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:8px; }
    .slot { padding:10px 5px; text-align:center; border-radius:6px; font-weight:500; font-size:0.9em; user-select:none; line-height:1.2; transition:all 0.15s; cursor:pointer; }
    .available { background:#2ecc71; color:white; }
    .available:hover { background:#27ae60; transform:translateY(-1px); }
    .booked { background:#e74c3c; color:white; }
    .blocked { background:#bdc3c7; color:#7f8c8d; cursor:not-allowed; opacity:0.8; }
    .lobby-clash { background:#9b59b6; color:white; cursor:not-allowed; }
    .external-booked { background:#f39c12; color:white; font-weight:700; cursor:not-allowed; }
    .past-time { background:#a0a0a0; color:white; cursor:not-allowed; opacity:0.6; } /* å·²éæ™‚é–“çš„æ¨£å¼ */
    .hidden-past { display: none !important; } /* éš±è—å·²éæ™‚é–“çš„æ¨£å¼ */
    
    .available-slots-area { margin-top:25px; padding:15px; background:#f8f9fa; border-radius:8px; }
    .available-slots-area strong { display:block; margin-bottom:8px; color:#e67e22; font-weight:700; }
    .copy-button { background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
    .copy-button:hover { background:#2980b9; }
    
    #controls { position:fixed; bottom:20px; right:20px; display:flex; gap:10px; z-index:999; }
    #controls button { padding:12px 20px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    #refresh { background:#3498db; }
    #copy-all { background:#8e44ad; }
    #copy-all:hover { background:#6d3588; }
    #clear { background:#e74c3c; }
    #override { background:#ff9f43; } /* æ–°å¢ Override æŒ‰éˆ•æ¨£å¼ (æ©˜è‰²ç³») */
    #override.active { background:#c0392b; } /* Override å•Ÿç”¨æ™‚ (æ·±ç´…è‰²) */

    #filter-controls { text-align:center; margin:10px 0 20px; font-weight:500; font-size:1.1em; color:#34495e; }
    #filter-controls input { margin-right:8px; transform:scale(1.2); }
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±</h1>

<div id="auth-container">
    <p id="user-status">è¼‰å…¥ä¸­...</p>
    <div id="google-signin-button"></div>
</div>
<div id="status-message" style="background:#bdc3c7;">è¼‰å…¥ä¸­...</div>

<div id="filter-controls">
    <label>
        <input type="checkbox" id="hide-past-toggle" onclick="toggleHidePastSlots()" checked> éš±è—å·²éæ™‚é–“
    </label>
</div>

<div class="legend">
    <div><span class="dot" style="background:#2ecc71"></span>å¯é ç´„</div>
    <div><span class="dot" style="background:#e74c3c"></span>æ‰‹å‹•é ç´„</div>
    <div><span class="dot" style="background:#f39c12"></span>æ—¥æ›†å·²è¨‚</div>
    <div><span class="dot" style="background:#a0a0a0"></span>å·²éæ™‚é–“</div>
    <div><span class="dot" style="background:#bdc3c7"></span>åŒä¸»é¡Œæ™‚çª—ä½”ç”¨ (ç·©è¡å€)</div>
    <div><span class="dot" style="background:#9b59b6"></span>åŒé¤¨è¡çª (é–‹å§‹æ™‚é–“äº’æ–¥)</div>
</div>

<div class="container">
    <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†)</h2><div class="slots" id="s1"></div><div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div></div>
    <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†)</h2><div class="slots" id="s2"></div><div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div></div>
    <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†)</h2><div class="slots" id="s3"></div><div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div></div>
    <div class="theme"><h2>æœ±ç ‚ (150åˆ†)</h2><div class="slots" id="s4"></div><div id="remaining-æœ±ç ‚" class="available-slots-area"></div></div>
</div>

<div id="controls">
    <button id="override" onclick="toggleOverrideMode()">é–‹æ”¾æ¨¡å¼</button>
    <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    <button id="copy-all" onclick="copyAllAvailableSlots()">å…¨éƒ¨è¤‡è£½</button>
    <button id="clear" onclick="clearAll()">ç™»å‡ºé‡è£½</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ================== è¨­å®šå€ ==================
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com';
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';
// =============================================

let localStorageKey = "mishi2025_final";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
let externalBookings = {};
let hidePastSlots = true;
let overrideMode = false;

// æ ¸å¿ƒé…ç½®ï¼šå ´é¤¨åˆ†çµ„å’Œç·©è¡æ™‚é–“ (æ–°å¢ store å±¬æ€§)
const CONFIG = {
    "301è™Ÿæˆ¿":      { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1", store: "å±±å­é ‚åº—" },
    "å¤±ç‰©æ‹›é ˜":    { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2", store: "å±±å­é ‚åº—" },
    "è—æ¨£çš„ä»£åƒ¹": { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3", store: "ä¸­å£¢åº—" },
    "æœ±ç ‚":        { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4", store: "ä¸­å£¢åº—" }
};

// å·¥å…·å‡½å¼
const tm = t => parseInt(t.split(":")[0])*60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;
const getCurrentMinutes = () => new Date().getHours() * 60 + new Date().getMinutes();

function generateTimes(interval) {
    let res = [];
    for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
    return res;
}

// --- Google Identity Service & Calendar API å‡½å¼ (èˆ‡å‰ç‰ˆç›¸åŒ) ---

function initGoogleSignIn() {
    google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false
    });
    google.accounts.id.renderButton(document.getElementById("google-signin-button"), { theme: "outline", size: "large" });
    document.getElementById('user-status').innerHTML = 'è«‹é»ä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google ä»¥åŒæ­¥æ—¥æ›†';
}

function handleCredentialResponse(response) {
    google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPE,
        callback: (resp) => {
            if (resp.error) { alert("ç™»å…¥å¤±æ•—ï¼š" + resp.error); return; }
            sessionStorage.setItem('google_access_token', resp.access_token);
            document.getElementById('user-status').innerHTML = 'å·²ç™»å…¥ï¼Œæ­£åœ¨è®€å–æ—¥æ›†...';
            document.getElementById('google-signin-button').style.display = 'none';
            render(true);
        }
    }).requestAccessToken();
}

async function fetchCalendarBookings() {
    const token = sessionStorage.getItem('google_access_token');
    const statusEl = document.getElementById('status-message');
    if (!token) return {};

    statusEl.innerHTML = 'æ­£åœ¨è®€å–æ‚¨çš„ Google æ—¥æ›†...'; statusEl.style.backgroundColor = '#3498db';

    try {
        const today = new Date();
        const timeMin = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
        const timeMax = new Date(today.getFullYear(), today.getMonth(), today.getDate()+1).toISOString();

        const res = await fetch(
            `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`,
            { headers: { Authorization: `Bearer ${token}` } }
        );

        if (!res.ok) throw new Error(`API ${res.status}`);

        const data = await res.json();
        statusEl.innerHTML = 'æ—¥æ›†åŒæ­¥å®Œæˆï¼'; statusEl.style.backgroundColor = '#2ecc71';

        const ext = {};
        Object.keys(CONFIG).forEach(k => ext[k] = []);

        data.items.forEach(item => {
            if (item.start?.dateTime && item.summary) {
                const start = new Date(item.start.dateTime);
                const timeStr = `${String(start.getHours()).padStart(2,'0')}:${String(start.getMinutes()).padStart(2,'0')}`;
                
                Object.keys(CONFIG).forEach(theme => {
                    if (item.summary.includes(theme)) {
                        ext[theme].push(timeStr);
                    }
                });
            }
        });
        return ext;
    } catch (err) {
        statusEl.innerHTML = `æ—¥æ›†è®€å–å¤±æ•—ï¼š${err.message}`; statusEl.style.backgroundColor = '#e74c3c';
        console.error(err);
        return {};
    }
}


// --- æ™‚æ®µç‹€æ…‹è¨ˆç®— (èˆ‡å‰ç‰ˆç›¸åŒ) ---
function calculateSlotStatus(theme, timeStr) {
    
    const cfg = CONFIG[theme];
    const cur = tm(timeStr);
    const dur = cfg.dur;

    if (localBookings[theme]?.includes(timeStr)) return 'booked';

    let isBlocked = false;
    let isLobbyClash = false;
    
    const allBookings = {};
    Object.keys(CONFIG).forEach(k => {
        allBookings[k] = localBookings[k] || [];
        if (!overrideMode) {
            allBookings[k] = allBookings[k].concat(externalBookings[k] || []);
        }
    });

    if (!overrideMode) {
        if (externalBookings[theme]?.includes(timeStr)) return 'external-booked';
    }


    Object.keys(CONFIG).forEach(otherTheme => {
        const otherConfig = CONFIG[otherTheme];
        
        allBookings[otherTheme].forEach(bookedTimeStr => {
            const bookedTime = tm(bookedTimeStr);
            
            if (cfg.group === otherConfig.group && theme !== otherTheme) {
                if (cur === bookedTime) {
                    isLobbyClash = true;
                }
            }

            if (theme === otherTheme) {
                const lockStartTime = bookedTime - otherConfig.block_before;
                const lockEndTime = bookedTime + otherConfig.dur + otherConfig.block_after;

                const slotStartTime = cur;
                const slotEndTime = cur + dur;
                
                const overlap = Math.max(0, Math.min(slotEndTime, lockEndTime) - Math.max(slotStartTime, lockStartTime));

                if (overlap > 0) {
                    isBlocked = true;
                }
            }
        });
    });

    if (isLobbyClash) return 'lobby-clash';
    if (isBlocked) return 'blocked';
    
    return 'available';
}


// --- è¦–è¦ºæ¸²æŸ“èˆ‡æ“ä½œ (èˆ‡å‰ç‰ˆç›¸åŒ) ---

function toggleOverrideMode() {
    const button = document.getElementById('override');
    overrideMode = !overrideMode;
    
    if (overrideMode) {
        button.classList.add('active');
        button.innerHTML = 'Override æ¨¡å¼ (å·²å•Ÿç”¨)';
        document.getElementById('status-message').innerHTML = 'âš ï¸ **å·²å•Ÿç”¨é–‹æ”¾æ¨¡å¼**ï¼šå¿½ç•¥æ—¥æ›†é ç´„èˆ‡å·²éæ™‚é–“ï¼Œä¿ç•™é¤¨å…§è¡çªã€‚';
        document.getElementById('status-message').style.backgroundColor = '#c0392b';
    } else {
        button.classList.remove('active');
        button.innerHTML = 'é–‹æ”¾æ¨¡å¼';
        if (sessionStorage.getItem('google_access_token')) {
             document.getElementById('status-message').innerHTML = 'æ—¥æ›†åŒæ­¥å®Œæˆï¼';
             document.getElementById('status-message').style.backgroundColor = '#2ecc71';
        } else {
             document.getElementById('status-message').innerHTML = 'å°šæœªç™»å…¥æ—¥æ›†ï¼Œè³‡æ–™å¯èƒ½ä¸å®Œæ•´ã€‚';
             document.getElementById('status-message').style.backgroundColor = '#bdc3c7';
        }
    }
    renderSlots();
}

function toggleHidePastSlots() {
    hidePastSlots = document.getElementById('hide-past-toggle').checked;
    renderSlots();
}

function toggleSlot(theme, time, el) {
    if (el.classList.contains('blocked') || el.classList.contains('lobby-clash') || el.classList.contains('past-time')) return; 

    if (!overrideMode && el.classList.contains('external-booked')) return;
    
    if (el.classList.contains('booked')) {
        localBookings[theme] = localBookings[theme].filter(t => t !== time);
        el.classList.remove('booked'); 
        el.classList.add(calculateSlotStatus(theme, time));
    } else {
        localBookings[theme].push(time);
        el.classList.remove('available', 'blocked', 'past-time', 'external-booked', 'lobby-clash'); 
        el.classList.add('booked');
    }
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    renderSlots();
    updateRemainingSlotsDisplay();
}

function renderSlots() {
    const currentMinutes = getCurrentMinutes();

    Object.keys(CONFIG).forEach(theme => {
        const {id, interval} = CONFIG[theme];
        const times = generateTimes(interval);
        let html = '';
        times.forEach(t => {
            const slotMinutes = tm(t);
            const isPast = slotMinutes < currentMinutes;

            let status = calculateSlotStatus(theme, t);
            let label = t;
            let slotClass = status;
            
            if (!overrideMode && isPast) {
                slotClass = 'past-time';
                if (hidePastSlots) {
                    slotClass += ' hidden-past';
                }
            }
            else if (overrideMode && status === 'available') {
                 label = t;
            }
            else {
                if (status === 'blocked') label += '<br>(ä½”ç”¨)';
                else if (status === 'lobby-clash') label += '<br>(è¡çª)';
                else if (status === 'external-booked') label += '<br>(æ—¥æ›†å·²è¨‚)';
            }
            
            html += `<div class="slot ${slotClass}" onclick="toggleSlot('${theme}','${t}',this)">${label}</div>`;
        });
        document.getElementById(id).innerHTML = html;
    });
    updateRemainingSlotsDisplay();
}

// --- ä¿®æ­£ updateRemainingSlotsDisplay é¡¯ç¤ºæ ¼å¼ ---
function updateRemainingSlotsDisplay() {
    const currentMinutes = getCurrentMinutes();
    const isOverride = overrideMode;

    Object.keys(CONFIG).forEach(theme => {
        const area = document.getElementById(`remaining-${theme}`);
        const times = generateTimes(CONFIG[theme].interval);
        
        const avail = times.filter(t => {
            const slotMinutes = tm(t);
            const isPast = slotMinutes < currentMinutes;
            const status = calculateSlotStatus(theme, t);
            
            if (isOverride) {
                return status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash';
            } else {
                return !isPast && status === 'available';
            }
        });

        const text = avail.length ? avail.join(', ') : (isOverride ? 'æ‰€æœ‰å¯é–‹æ™‚æ®µçš†å·²è¢«é ç´„/è¡çª' : 'ä»Šæ—¥ç„¡ç©ºæª”');
        
        // ğŸŒŸ ä¿®æ­£å–®æ¬„è¤‡è£½çš„æ ¼å¼ï¼Œç§»é™¤åˆ†é˜æ•¸
        const full = `${theme}: ${avail.join(', ')}`;

        area.innerHTML = `<strong>${theme} å¯é ç´„ (${avail.length}æª”)${isOverride ? ' [é–‹æ”¾æ¨¡å¼]' : ''}ï¼š</strong>
            <div style="margin:8px 0; word-break:break-all;">${text.length>200 ? avail.slice(0,15).join(', ')+'...' : text}</div>
            <button class="copy-button" onclick="navigator.clipboard.writeText('${full}').then(()=>alert('å·²è¤‡è£½ ${theme} å¯é ç´„æ™‚é–“ï¼'))">è¤‡è£½æœ¬æ¬„</button>`;
    });
}

// --- ä¿®æ­£ copyAllAvailableSlots è¤‡è£½æ ¼å¼ ---
function copyAllAvailableSlots() {
    const currentMinutes = getCurrentMinutes();
    const isOverride = overrideMode;
    
    let allSlotsData = {}; // ç”¨ä¾†å„²å­˜ {åº—å: {ä¸»é¡Œ: [æ™‚æ®µ, ...]}}

    // 1. æ•´ç†æ‰€æœ‰ä¸»é¡Œçš„å‰©é¤˜å ´æ¬¡
    Object.keys(CONFIG).forEach(theme => {
        const { store, interval } = CONFIG[theme];
        const times = generateTimes(interval);
        
        const avail = times.filter(t => {
            const slotMinutes = tm(t);
            const isPast = slotMinutes < currentMinutes;
            const status = calculateSlotStatus(theme, t);
            
            if (isOverride) {
                return status !== 'booked' && status !== 'blocked' && status !== 'lobby-clash';
            } else {
                return !isPast && status === 'available';
            }
        });

        if (!allSlotsData[store]) {
            allSlotsData[store] = {};
        }
        allSlotsData[store][theme] = avail;
    });

    let outputText = "ä»Šæ—¥å‰©é¤˜å ´æ¬¡\n\n";
    let hasAvailable = false;

    // 2. æŒ‰ç…§åº—åå’Œä¸»é¡Œé †åºè¼¸å‡º
    // é æœŸé †åºï¼šä¸­å£¢åº— (è—æ¨£çš„ä»£åƒ¹, æœ±ç ‚), å±±å­é ‚åº— (301è™Ÿæˆ¿, å¤±ç‰©æ‹›é ˜)
    const storeOrder = ["ä¸­å£¢åº—", "å±±å­é ‚åº—"];
    const themeOrder = Object.keys(CONFIG);

    storeOrder.forEach(storeName => {
        outputText += `${storeName}\n`;
        
        // éæ¿¾å‡ºå±¬æ–¼è©²åº—çš„ä¸»é¡Œï¼Œä¸¦ä¾ç…§ CONFIG ä¸­çš„é †åºæ’åº (æˆ–ä¿æŒåŸæ¨£)
        themeOrder.forEach(theme => {
             if (CONFIG[theme].store === storeName) {
                const avail = allSlotsData[storeName][theme] || [];
                const timeStr = avail.length ? avail.join(', ') : 'ä»Šæ—¥ç„¡ç©ºæª”';

                // ğŸŒŸ è¼¸å‡ºæ ¼å¼ï¼šä¸»é¡Œåç¨±: æ™‚æ®µåˆ—è¡¨
                outputText += `${theme}: ${timeStr}\n`;
                if (avail.length > 0) hasAvailable = true;
             }
        });
        outputText += "\n";
    });

    // 3. è™•ç†æ¨¡å¼æç¤º
    const modeAlert = isOverride ? `âš ï¸ æ³¨æ„ï¼šè¤‡è£½çš„æ˜¯é–‹æ”¾æ¨¡å¼ä¸‹ã€æœªè¢«å…§éƒ¨è¡çªé–å®šã€‘çš„æ‰€æœ‰æ™‚æ®µã€‚\n` : ``;
    outputText = modeAlert + outputText.trim();


    navigator.clipboard.writeText(outputText).then(() => {
        alert('æ‰€æœ‰ä¸»é¡Œçš„å‰©é¤˜å¯é ç´„æ™‚é–“å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
    });
}

async function render(doFetch = true) {
    if (doFetch) externalBookings = await fetchCalendarBookings();
    renderSlots();
}

function clearAll() {
    sessionStorage.clear();
    localStorage.removeItem(localStorageKey);
    location.reload();
}

// åˆå§‹è¼‰å…¥
window.onload = () => {
    Object.keys(CONFIG).forEach(k => { if (!localBookings[k]) localBookings[k] = []; });
    initGoogleSignIn();
    
    if (sessionStorage.getItem('google_access_token')) {
        document.getElementById('user-status').innerHTML = 'å·²ç™»å…¥ï¼Œè®€å–æ—¥æ›†ä¸­...';
        document.getElementById('google-signin-button').style.display = 'none';
        render(true);
    } else {
        document.getElementById('status-message').innerHTML = 'å°šæœªç™»å…¥æ—¥æ›†ï¼Œè³‡æ–™å¯èƒ½ä¸å®Œæ•´ã€‚';
        document.getElementById('status-message').style.backgroundColor = '#bdc3c7';
        render(false); 
    }
    
    const overrideButton = document.getElementById('override');
    if (overrideMode) {
        overrideButton.classList.add('active');
        overrideButton.innerHTML = 'Override æ¨¡å¼ (å·²å•Ÿç”¨)';
        document.getElementById('status-message').innerHTML = 'âš ï¸ **å·²å•Ÿç”¨é–‹æ”¾æ¨¡å¼**ï¼šå¿½ç•¥æ—¥æ›†é ç´„èˆ‡å·²éæ™‚é–“ï¼Œä¿ç•™é¤¨å…§è¡çªã€‚';
        document.getElementById('status-message').style.backgroundColor = '#c0392b';
    }
};
</script>
</body>
</html>