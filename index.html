<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ å…§éƒ¨æ™‚é–“è¡¨ v14.1 (æœ€çµ‚ç‰ˆ)</title>
<style>
Â  /* æ¨£å¼å€å¡Šä¿æŒä¸è®Š */
Â  body{font-family:"Microsoft JhengHei",sans-serif;background:#2c3e50;color:#fff;padding:20px;margin:0;}
Â  h1{text-align:center;margin:30px 0 10px 0;font-size:2em;}
Â  #status-message {
Â  Â  text-align: center;Â 
Â  Â  margin-bottom: 20px;Â 
Â  Â  font-weight: bold;Â 
Â  Â  padding: 10px;
Â  Â  border-radius: 8px;
Â  }
Â  #status-message a { font-weight: bold; }
Â Â 
Â  #auth-container { text-align: center; margin-bottom: 20px; padding: 10px; }
Â  #user-status { margin: 5px 0; font-size: 1.1em; }
Â  /* ç™»å…¥æŒ‰éˆ•ç¾åœ¨é è¨­ç‚º blockï¼Œå…è¨± gisInit æ¸²æŸ“ */
Â  #google-signin-button { display: block; margin: 10px auto; } 
Â Â 
Â  .container {display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;}
Â  .theme{background:#34495e;padding:20px;border-radius:15px;width:100%;max-width:650px; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
Â  .theme h2{text-align:center;background:#2c3e50;padding:12px;border-radius:10px;margin:0 0 15px 0;}
Â  .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;}
Â Â 
Â  .slot{padding:12px 5px;text-align:center;border-radius:10px;font-weight:bold;font-size:0.9em;transition:all 0.15s;user-select:none; position: relative;}
Â Â 
Â  .available{background:#27ae60;cursor:pointer;border: 2px solid #2ecc71;}
Â  .booked{background:#e74c3c;cursor:pointer;border: 2px solid #c0392b;}
Â  .blocked{ background:#566573; color:#bdc3c7; cursor:not-allowed; opacity:0.6; font-size: 0.8em; line-height: 1.1; border: 2px solid #4a545e; }
Â  .lobby-clash{background:#9b59b6; color: white;}Â 
Â  .external-booked{background:#f39c12; color: white; cursor:not-allowed; border: 2px solid #e67e22; opacity: 1.0;}

Â  .available-slots-area { margin-top: 20px; padding: 10px 0; border-top: 1px dashed #4a545e; display: flex; justify-content: space-between; align-items: flex-start; }
Â  .available-slots-area strong { display: block; margin-bottom: 5px; color: #f1c40f; flex-shrink: 0; }
Â  .copy-button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: background 0.2s; flex-shrink: 0; margin-left: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
Â  .copy-button:hover {background: #2980b9;}

Â  #controls {position:fixed;bottom:20px;right:20px;display: flex; gap: 10px; z-index:999;}
Â  button {border:none; padding:15px 25px; border-radius:50px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
Â  #clear{background:#e67e22;color:white;}
Â  #refresh{background:#3498db;color:white;}
Â Â 
Â  .legend {text-align: center; margin-bottom: 20px; font-size: 0.9em; display: flex; justify-content: center; gap: 15px;}
Â  .dot {display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px;}
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ å…§éƒ¨æ™‚é–“è¡¨ v14.1 (æœ€çµ‚ç‰ˆ)</h1>

<div id="auth-container">
Â  Â  <p id="user-status" style="color: #f1c40f;">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
Â  Â  <div id="google-signin-button"></div>Â 
</div>
<div id="status-message" style="text-align: center; margin-bottom: 20px; font-weight: bold; color: #f1c40f;">è¼‰å…¥ä¸­...</div>

<div class="legend">
Â  <div><span class="dot" style="background:#27ae60"></span>å¯é ç´„</div>
Â  <div><span class="dot" style="background:#e74c3c"></span>æ‰‹å‹•é ç´„ (é»æ“Šå–æ¶ˆ)</div>
Â  <div><span class="dot" style="background:#f39c12"></span>**æ—¥æ›†é ç´„**</div>
Â  <div><span class="dot" style="background:#566573"></span>æ™‚çª—ä½”ç”¨</div>
Â  <div><span class="dot" style="background:#9b59b6"></span>åŒé¤¨é–‹å ´è¡çª</div>
</div>

<div class="container">
Â  <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div>
Â  Â  <div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div>
Â  Â  <div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div>
Â  Â  <div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div>
Â  </div>
Â  <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s4"></div>
Â  Â  <div id="remaining-æœ±ç ‚" class="available-slots-area"></div>
Â  </div>
</div>

<div id="controls">
Â  <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
Â  <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½®</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer data-is_client></script>Â 

<script>
// =================================================================
// ğŸš¨ è¨­å®šå€ ğŸš¨
// 1. æ‚¨çš„ OAuth Client ID (è«‹è‡ªè¡Œå¡«å…¥æ‚¨ç¢ºå®šåœ¨GCPä¸­è¨­å®šäº†ã€Œé‡æ–°å°å‘URIã€çš„é‚£å€‹ID)
const CLIENT_ID = '633792240290-d9f0c3ou123879t35tihdniqdpi9gfgg.apps.googleusercontent.com'; 
// 2. æ‚¨çš„æœ€æ–° GAS éƒ¨ç½² URL (å·²å¡«å…¥)
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwrqS0A9Qwbleb7XebMCWGp2mYXC6Sbun327URwoHN1rrbvUy5C37Dq2gpypum9Pr---Q/exec';
// 3. è«‹æ±‚æ—¥æ›†æ¬Šé™çš„ç¯„åœ
const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';

// æ ¸å¿ƒé…ç½® (ä¿æŒä¸è®Š)
const CONFIG = {
Â  "301è™Ÿæˆ¿":Â  Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
Â  "å¤±ç‰©æ‹›é ˜":Â  Â  { dur: 90,Â  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
Â  "è—æ¨£çš„ä»£åƒ¹":Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" },Â 
Â  "æœ±ç ‚":Â  Â  Â  Â  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }Â Â 
};
// =================================================================

let localStorageKey = "mishi2025_v14";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });

let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const tm = t => parseInt(t.split(":")[0]) * 60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
Â  let res = [];
Â  for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
Â  return res;
}

// --- Google ç™»å…¥é‚è¼¯ (å·²åˆ‡æ›ç‚ºé‡æ–°å°å‘æ¨¡å¼ - Redirect Mode) ---
let gisInited = false;

function gisInit() {
Â  Â  const userStatusEl = document.getElementById('user-status');
Â  Â  const signInButtonEl = document.getElementById('google-signin-button');

Â  Â  // 1. æª¢æŸ¥ç¶²å€åˆ—æ˜¯å¦åŒ…å« Google å°å›çš„ Token (åœ¨ URL fragment ä¸­)
Â  Â  const urlParams = new URLSearchParams(window.location.hash.substring(1));
Â  Â  const accessToken = urlParams.get('access_token');

Â  Â  if (accessToken) {
Â  Â  Â  Â  // ç™»å…¥æˆåŠŸï¼Œå„²å­˜ Token ä¸¦æ¸…ç†ç¶²å€åˆ—
Â  Â  Â  Â  sessionStorage.setItem('google_access_token', accessToken);
Â  Â  Â  Â  // æ¸…ç† URL fragmentï¼Œä¿æŒç•«é¢ä¹¾æ·¨
Â  Â  Â  Â  history.replaceState(null, null, window.location.pathname); 
Â  Â  }

Â  Â  // 2. æª¢æŸ¥æ˜¯å¦æœ‰ Token
Â  Â  if (sessionStorage.getItem('google_access_token')) {
Â  Â  Â  Â  userStatusEl.innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
Â  Â  Â  Â  signInButtonEl.style.display = 'none'; // éš±è—æŒ‰éˆ•
Â  Â  Â  Â  render(true);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 3. åˆå§‹åŒ– Google é‡æ–°å°å‘ç™»å…¥è¨­å®š
Â  Â  window.google.accounts.id.initialize({
Â  Â  Â  Â  client_id: CLIENT_ID,
Â  Â  Â  Â  callback: null, // Rediect æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ callback
Â  Â  Â  Â  flow: 'implicit', // ä½¿ç”¨ implicit flow ç²å– access_token
Â  Â  Â  Â  ux_mode: 'redirect', // å¼·åˆ¶ä½¿ç”¨é‡æ–°å°å‘æ¨¡å¼
Â  Â  Â  Â  // å¿…é ˆæ˜¯ GCI è£¡è¨­å®šçš„ã€Œå·²æˆæ¬Šçš„é‡æ–°å°å‘ URIã€
Â  Â  Â  Â  redirect_uri: window.location.origin + '/booking-system/', 
Â  Â  Â  Â  scope: SCOPE
Â  Â  });
Â  Â Â 
Â  Â  // 4. æ¸²æŸ“ç™»å…¥æŒ‰éˆ•
Â  Â  userStatusEl.innerHTML = 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google é€²è¡ŒåŒæ­¥ã€‚';
Â  Â  signInButtonEl.style.display = 'block'; // é¡¯ç¤ºæŒ‰éˆ•
Â  Â Â 
Â  Â  window.google.accounts.id.renderButton(
Â  Â  Â  Â  signInButtonEl,
Â  Â  Â  Â  { theme: 'outline', size: 'large', type: 'standard', text: 'signin_with' }
Â  Â  );

Â  Â  gisInited = true;
Â  Â  render(false); // æœªç™»å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“æœ¬åœ°è³‡æ–™
}

// -------------------------------------------------------------------
// æ ¸å¿ƒæ•¸æ“šè®€å– (ä¿æŒä¸è®Š)
// -------------------------------------------------------------------

async function fetchCalendarBookings(gasUrl) {
Â  Â  const statusEl = document.getElementById('status-message');
Â  Â  const token = sessionStorage.getItem('google_access_token');
Â  Â Â 
Â  Â  if (!token) {
Â  Â  Â  Â  statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Googleã€‚ç„¡æ³•åŒæ­¥æ—¥æ›†ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#566573';
Â  Â  Â  Â  return {};Â 
Â  Â  }
Â  Â Â 
Â  Â  statusEl.innerHTML = 'æ­£åœ¨ä½¿ç”¨æ‚¨çš„æ†‘è­‰å‘æ—¥æ›†ä¼ºæœå™¨è«‹æ±‚è³‡æ–™...';

Â  Â  try {
Â  Â  Â  Â  const fetchUrl = `${gasUrl}?token=${token}`;Â 
Â  Â  Â  Â  const response = await fetch(fetchUrl);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!response.ok) { throw new Error(`ç¶²è·¯éŒ¯èª¤ ${response.status}`); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const calendarEvents = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æª¢æŸ¥ GAS è¿”å›çš„éŒ¯èª¤ (å¦‚ Token å¤±æ•ˆ)
Â  Â  Â  Â  if (calendarEvents.error) {
Â  Â  Â  Â  Â  Â  if (calendarEvents.error === "TOKEN_INVALID" || calendarEvents.error === "API_ERROR") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥æ†‘è­‰ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€ï¼';
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('google_access_token'); // æ¸…é™¤ Token
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerHTML = 'è«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€é‡æ–°é–‹å§‹ç™»å…¥ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#543030';
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Token/Auth Failed");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  statusEl.innerHTML = `ğŸ›‘ GAS ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤: ${calendarEvents.message || 'æœªçŸ¥'}`;
Â  Â  Â  Â  Â  Â  statusEl.style.backgroundColor = '#543030';
Â  Â  Â  Â  Â  Â  throw new Error("EXECUTION_FAILED");
Â  Â  Â  Â  }


Â  Â  Â  Â  // æˆæ¬ŠæˆåŠŸ
Â  Â  Â  Â  statusEl.innerHTML = 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå·²åŒæ­¥æ‚¨çš„æ—¥æ›†äº‹ä»¶ã€‚';
Â  Â  Â  Â  statusEl.style.backgroundColor = '#1e8449';
Â  Â  Â  Â  statusEl.style.color = 'white';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è™•ç†äº‹ä»¶
Â  Â  Â  Â  let tempExternalBookings = {};
Â  Â  Â  Â  Object.keys(CONFIG).forEach(k => tempExternalBookings[k] = []);
Â  Â  Â  Â  calendarEvents.forEach(event => {
Â  Â  Â  Â  Â  Â  if (CONFIG[event.theme] && event.time) {
Â  Â  Â  Â  Â  Â  Â  Â  tempExternalBookings[event.theme].push(event.time);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  return tempExternalBookings;


Â  Â  } catch (error) {
Â  Â  Â  Â  if (!["Token/Auth Failed", "EXECUTION_FAILED"].includes(error.message)) {
Â  Â  Â  Â  Â  Â  Â statusEl.innerHTML = `<p style="color:#f39c12; font-weight:bold; margin: 0;">âš ï¸ è¼‰å…¥æ—¥æ›†è³‡æ–™å¤±æ•—ï¼</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color:#ecf0f1;">éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
Â  Â  Â  Â  Â  Â  Â statusEl.style.backgroundColor = '#566573';
Â  Â  Â  Â  Â  Â  Â statusEl.style.color = 'white';
Â  Â  Â  Â  }
Â  Â  Â  Â  return {};Â 
Â  Â  }
}

// -------------------------------------------------------------------
// ç‹€æ…‹æª¢æŸ¥ã€åˆ‡æ›ã€ç¹ªè£½é‚è¼¯ (ä¿æŒä¸è®Š)
// -------------------------------------------------------------------

function getStatus(theme, tVal) {
Â  const conf = CONFIG[theme];
Â  const tStr = valToStr(tVal);
Â  if (externalBookings[theme] && externalBookings[theme].includes(tStr)) return 'external-booked';
Â  if (localBookings[theme].includes(tStr)) return 'booked';
Â  const mate = Object.keys(CONFIG).find(k => CONFIG[k].group === conf.group && k !== theme);
Â  if (combinedBookings[mate] && combinedBookings[mate].includes(tStr)) return 'lobby-clash';
Â  for (let startStr of combinedBookings[theme]) {
Â  Â  let s = tm(startStr);
Â  Â  let s_block = s - conf.block_before;
Â  Â  let e_block = s + conf.block_after;Â 
Â  Â  if (tVal >= s_block && tVal < e_block) return 'blocked';
Â  }
Â  return 'available';
}

function checkConflict(theme, tVal) {
Â  Â  const conf = CONFIG[theme];
Â  Â  const s_new_buffer = tVal - conf.block_before;
Â  Â  const e_new_buffer = tVal + conf.block_after;
Â  Â  return combinedBookings[theme].some(existStr => {
Â  Â  Â  const s_exist = tm(existStr);
Â  Â  Â  const s_exist_buffer = s_exist - conf.block_before;
Â  Â  Â  const e_exist_buffer = s_exist + conf.block_after;
Â  Â  Â  if (s_new_buffer < e_exist_buffer && e_new_buffer > s_exist_buffer) {
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  });
}

function toggle(theme, time) {
Â  const tVal = tm(time);
Â  if (externalBookings[theme] && externalBookings[theme].includes(time)) {
Â  Â  Â  console.warn("æ­¤ç‚ºæ—¥æ›†é ç´„ï¼Œè«‹è‡³ Google æ—¥æ›†ä¸Šä¿®æ”¹æˆ–åˆªé™¤ã€‚");
Â  Â  Â  return;Â 
Â  }
Â  const idx = localBookings[theme].indexOf(time);
Â  if (idx > -1) {
Â  Â  localBookings[theme].splice(idx,1);
Â  } else {
Â  Â  if (getStatus(theme, tVal) !== 'available') return;Â 
Â  Â  if (checkConflict(theme, tVal)) return;
Â  Â  localBookings[theme].push(time);
Â  }
Â  localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
Â  render(false);Â 
}

function clearAll() {
Â  Â  Object.keys(localBookings).forEach(key => localBookings[key] = []);
Â  Â  localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
Â  Â Â 
Â  Â  // æ¸…é™¤ sessionStorage ä¸­çš„ tokenï¼Œå¼·åˆ¶é‡æ–°ç™»å…¥
Â  Â  sessionStorage.removeItem('google_access_token');Â 
Â  Â  location.reload();Â 
}

function copyAvailableSlots(theme) {
Â  const element = document.getElementById(`remaining-${theme}`);
Â  const slotsText = element.querySelector('.slot-text').innerText;
Â  const textToCopy = `${theme}å‰©é¤˜å ´æ¬¡ï¼š${slotsText}`;
Â  if (navigator.clipboard && navigator.clipboard.writeText) {
Â  Â  navigator.clipboard.writeText(textToCopy)
Â  Â  Â  .then(() => {
Â  Â  Â  Â  const button = element.querySelector('.copy-button');
Â  Â  Â  Â  button.innerText = 'å·²è¤‡è£½ï¼';
Â  Â  Â  Â  setTimeout(() => button.innerText = 'ä¸€éµè¤‡è£½', 1500);
Â  Â  Â  })
Â  Â  Â  .catch(err => {
Â  Â  Â  Â  const button = element.querySelector('.copy-button');
Â  Â  Â  Â  button.innerText = 'è¤‡è£½å¤±æ•—';
Â  Â  Â  });
Â  } else {
Â  Â  const button = element.querySelector('.copy-button');
Â  Â  button.innerText = 'è¤‡è£½å¤±æ•— (è«‹æ‰‹å‹•)';
Â  }
}

async function render(shouldFetch = true) {
Â  Â  // æœªç™»å…¥ä¸”å°šæœªåˆå§‹åŒ–ï¼Œå‰‡é€²è¡Œåˆå§‹åŒ–æµç¨‹
Â  Â  if (!gisInited && !sessionStorage.getItem('google_access_token')) { 
Â  Â  Â  Â  gisInit();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  let fetchError = false;
Â  Â  if (shouldFetch && sessionStorage.getItem('google_access_token')) {
Â  Â  Â  Â  const fetchedEvents = await fetchCalendarBookings(GAS_URL);
Â  Â  Â  Â  externalBookings = fetchedEvents;
Â  Â  Â  Â  const statusEl = document.getElementById('status-message');
Â  Â  Â  Â  // æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡éŒ¯èª¤
Â  Â  Â  Â  if (statusEl.innerHTML.includes('âŒ') || statusEl.innerHTML.includes('ğŸ›‘') || statusEl.innerHTML.includes('âš ï¸')) {
Â  Â  Â  Â  Â  Â  fetchError = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // åˆä½µæœ¬åœ°é ç´„å’Œæ—¥æ›†é ç´„
Â  Â  combinedBookings = JSON.parse(JSON.stringify(localBookings));
Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  Â  if (externalBookings[theme]) {
Â  Â  Â  Â  Â  Â  externalBookings[theme].forEach(time => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!combinedBookings[theme].includes(time)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  combinedBookings[theme].push(time);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!combinedBookings[theme]) combinedBookings[theme] = [];Â 
Â  Â  });
Â  Â Â 
Â  Â  // éŒ¯èª¤è™•ç†é¡¯ç¤º
Â  Â  if (fetchError && shouldFetch) {
Â  Â  Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  Â  Â  Â  document.getElementById(CONFIG[theme].id).innerHTML = `<div style="color:#e74c3c; text-align:center; padding: 20px;">è«‹å…ˆè§£æ±ºä¸Šæ–¹æç¤ºçš„éŒ¯èª¤æˆ–ç™»å…¥ã€‚</div>`;
Â  Â  Â  Â  Â  Â  document.getElementById(`remaining-${theme}`).innerHTML = `<strong>å‰©é¤˜å ´æ¬¡ï¼š</strong><span class="slot-text" style="color:#e74c3c;">ç„¡æ³•åŒæ­¥</span>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // æ­£å¸¸æ¸²æŸ“æµç¨‹
Â  Â  const allTimes = {};
Â  Â Â 
Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  const conf = CONFIG[theme];
Â  Â  Â  const el = document.getElementById(conf.id);
Â  Â  Â  const times = generateTimes(conf.interval);
Â  Â  Â  let availableTimes = [];

Â  Â  Â  el.innerHTML = times.map(t => {
Â  Â  Â  Â  const tVal = tm(t);
Â  Â  Â  Â  const s = getStatus(theme, tVal);
Â  Â  Â  Â  let label = t;
Â  Â  Â  Â  let cls = s;
Â  Â  Â  Â  let onClick = `onclick="toggle('${theme}','${t}')"`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (s === 'booked') { }Â 
Â  Â  Â  Â  else if (s === 'external-booked') {
Â  Â  Â  Â  Â  cls = 'external-booked'; label = t + ' (æ—¥æ›†)'; onClick = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (s === 'lobby-clash') {Â 
Â  Â  Â  Â  Â  cls = 'lobby-clash'; label = 'é–‹å ´è¡çª'; onClick = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  else if (s === 'blocked') {Â 
Â  Â  Â  Â  Â  const totalMinutes = conf.block_before + conf.block_after;
Â  Â  Â  Â  Â  label = `ä½”ç”¨ (${totalMinutes}åˆ†)`; onClick = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (checkConflict(theme, tVal)) {
Â  Â  Â  Â  Â  Â  Â  cls = 'blocked'; label = 'æ’ç¨‹è¡çª'; onClick = '';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  availableTimes.push(t);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return `<div class="slot ${cls}" ${onClick}>${label}</div>`;
Â  Â  Â  }).join('');
Â  Â  Â  allTimes[theme] = availableTimes;
Â  Â  });

Â  Â  Object.keys(CONFIG).forEach(theme => {
Â  Â  Â  const areaEl = document.getElementById(`remaining-${theme}`);
Â  Â  Â  const availableSlots = allTimes[theme] || [];
Â  Â  Â  const slotsText = availableSlots.join(', ') || 'æœ¬æ—¥ç„¡å‰©é¤˜å ´æ¬¡';
Â  Â  Â  areaEl.innerHTML = `
Â  Â  Â  Â  <div style="display: flex; align-items: flex-start; width: 100%;">
Â  Â  Â  Â  Â  Â  <strong>å‰©é¤˜å ´æ¬¡ï¼š</strong>
Â  Â  Â  Â  Â  Â  <div class="slot-text-container">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="slot-text">${slotsText}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="copy-button" onclick="copyAvailableSlots('${theme}')">ä¸€éµè¤‡è£½</button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  });
}

// ç¢ºä¿é¦–æ¬¡è¼‰å…¥æ™‚åˆå§‹åŒ– Google ç™»å…¥
window.onload = gisInit;
</script>
</body>
</html>