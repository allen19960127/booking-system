<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ± (ä¸€å®šæˆåŠŸç‰ˆ)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
<style>
    /* æ¨£å¼ç¢¼ä¿æŒä¸è®Š */
    body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; color: #2c3e50; padding: 20px; margin: 0; line-height: 1.6; }
    h1 { text-align: center; margin: 20px 0 10px 0; font-size: 2.2em; color: #34495e; font-weight: 700; }
    #auth-container { text-align: center; margin-bottom: 25px; padding: 15px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
    #user-status { margin: 5px 0 15px 0; font-size: 1.1em; color: #2980b9; font-weight: 500; }
    #status-message { text-align: center; margin-bottom: 20px; font-weight: bold; padding: 12px; border-radius: 8px; transition: background-color 0.3s; color: white; }
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; }
    .theme { background-color: #ffffff; padding: 20px; border-radius: 12px; width: 100%; max-width: 650px; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s; border-top: 5px solid #3498db; }
    .theme h2 { text-align: center; background-color: #ecf0f1; padding: 12px; border-radius: 8px; margin: 0 0 20px 0; font-size: 1.5em; color: #34495e; }
    .slots { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    .slot { padding: 10px 5px; text-align: center; border-radius: 6px; font-weight: 500; font-size: 0.9em; transition: all 0.15s; user-select: none; border: 1px solid transparent; line-height: 1.2; }
    .available { background-color: #2ecc71; color: white; cursor: pointer; border-color: #27ae60; }
    .available:hover { background-color: #27ae60; transform: translateY(-1px); }
    .booked { background-color: #e74c3c; color: white; cursor: pointer; border-color: #c0392b; }
    .booked:hover { background-color: #c0392b; transform: translateY(-1px); }
    .blocked { background-color: #bdc3c7; color: #7f8c8d; cursor: not-allowed; opacity: 0.8; font-size: 0.8em; border-color: #95a5a6; }
    .lobby-clash { background-color: #9b59b6; color: white; border-color: #8e44ad; cursor: not-allowed; }
    .external-booked { background-color: #f39c12; color: white; cursor: not-allowed; font-weight: 700; border-color: #e67e22; }
    .available-slots-area { margin-top: 25px; padding: 15px 0; border-top: 1px solid #ecf0f1; display: flex; flex-direction: column; align-items: flex-start; background-color: #f8f9fa; padding: 15px; border-radius: 8px; }
    .available-slots-area strong { display: block; margin-bottom: 8px; color: #e67e22; font-weight: 700; }
    .slot-text-container { width: 100%; margin-bottom: 10px; }
    .copy-button { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background 0.2s, transform 0.1s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .copy-button:hover { background-color: #2980b9; transform: translateY(-1px); }
    #controls { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; z-index: 999; }
    #controls button { border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: background 0.2s, transform 0.1s; }
    #clear { background-color: #e74c3c; color: white; }
    #clear:hover { background-color: #c0392b; transform: translateY(-1px); }
    #refresh { background-color: #3498db; color: white; }
    #refresh:hover { background-color: #2980b9; transform: translateY(-1px); }
    .legend { text-align: center; margin-bottom: 25px; font-size: 0.9em; display: flex; justify-content: center; gap: 20px; color: #555; }
    .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; border: 1px solid rgba(0, 0, 0, 0.1); }
</style>
</head>
<body>
<h1>è¬å¤±å·¥ä½œå®¤ æ’ç¨‹åŒæ­¥ç³»çµ±</h1>

<div id="auth-container">
    <p id="user-status">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</p>
    <div id="google-signin-button"></div> 
</div>
<div id="status-message" style="background-color: #bdc3c7; color: white;">è¼‰å…¥ä¸­...</div>

<div class="legend">
    <div><span class="dot" style="background-color:#2ecc71"></span>å¯é ç´„</div>
    <div><span class="dot" style="background-color:#e74c3c"></span>æ‰‹å‹•é ç´„</div>
    <div><span class="dot" style="background-color:#f39c12"></span>æ—¥æ›†é ç´„</div>
    <div><span class="dot" style="background-color:#bdc3c7"></span>æ™‚çª—ä½”ç”¨</div>
    <div><span class="dot" style="background-color:#9b59b6"></span>åŒé¤¨è¡çª</div>
</div>

<div class="container">
    <div class="theme"><h2>301è™Ÿæˆ¿ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s1"></div>
        <div id="remaining-301è™Ÿæˆ¿" class="available-slots-area"></div>
    </div>
    <div class="theme"><h2>å¤±ç‰©æ‹›é ˜ (90åˆ†, ç¸½æ™‚çª—90åˆ†)</h2><div class="slots" id="s2"></div>
        <div id="remaining-å¤±ç‰©æ‹›é ˜" class="available-slots-area"></div>
    </div>
    <div class="theme"><h2>è—æ¨£çš„ä»£åƒ¹ (150åˆ†, ç¸½æ™‚çª—150åˆ†)</h2><div class="slots" id="s3"></div>
        <div id="remaining-è—æ¨£çš„ä»£åƒ¹" class="available-slots-area"></div>
    </div>
    <div class="theme"><h2>æœ±ç ‚ (150åˆ†, ç¸½æ™‚çª—150åˆ†) </h2><div class="slots" id="s4"></div>
        <div id="remaining-æœ±ç ‚" class="available-slots-area"></div>
    </div>
</div>

<div id="controls">
    <button id="refresh" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    <button id="clear" onclick="clearAll()">æ¸…ç©ºé‡ç½® (ç™»å‡º)</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script> 

<script>
// =================================================================
// ğŸš¨ è¨­å®šå€ - è«‹æ›¿æ›ä»¥ä¸‹å…©å€‹åƒæ•¸ ğŸš¨
// =================================================================
// æ‚¨ä¹‹å‰æä¾›çš„ CLIENT_ID
const CLIENT_ID = '668108664338-d1fa84nmbpq0leo5tavf9n0cahg2g1ge.apps.googleusercontent.com'; 

// âœ… é€™æ˜¯æ‚¨æœ€æ–°ä¸”å·²éƒ¨ç½² doPost(e) çš„ Apps Script URL
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzqp4pJuyZlthT3KR0vnBl-tDPkxmtrnNJXO5GlnAZZyXVACKRnFCcHjUZyJkFysm98/exec';

const SCOPE = 'https://www.googleapis.com/auth/calendar.readonly';

// æ ¸å¿ƒé…ç½® (ä¿æŒä¸è®Š)
const CONFIG = {
    "301è™Ÿæˆ¿":      { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s1" },
    "å¤±ç‰©æ‹›é ˜":    { dur: 90,  group: "é¤¨A", interval: 15, block_before: 45, block_after: 45, id: "s2" },
    "è—æ¨£çš„ä»£åƒ¹":  { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s3" }, 
    "æœ±ç ‚":        { dur: 150, group: "é¤¨B", interval: 30, block_before: 75, block_after: 75, id: "s4" }  
};
// =================================================================
let localStorageKey = "mishi2025_v14";
let localBookings = JSON.parse(localStorage.getItem(localStorageKey) || '{}');
Object.keys(CONFIG).forEach(k => { if(!localBookings[k]) localBookings[k] = []; });

let combinedBookings = JSON.parse(JSON.stringify(localBookings));
let externalBookings = {};

const tm = t => parseInt(t.split(":")[0]) * 60 + parseInt(t.split(":")[1]);
const valToStr = v => `${String(Math.floor(v/60)).padStart(2,'0')}:${String(v%60).padStart(2,'0')}`;

function generateTimes(interval) {
    let res = [];
    for(let t=630; t<=1260; t+=interval) res.push(valToStr(t)); // 10:30-21:00
    return res;
}

// --- Google ç™»å…¥é‚è¼¯ (Redirect Mode) ---
let gisInited = false;

function gisInit() {
    const userStatusEl = document.getElementById('user-status');
    const signInButtonEl = document.getElementById('google-signin-button');

    // 1. æª¢æŸ¥ç¶²å€åˆ—æ˜¯å¦åŒ…å« Google å°å›çš„ Token
    const urlParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = urlParams.get('access_token');

    if (accessToken) {
        // ç™»å…¥æˆåŠŸï¼Œå„²å­˜ Token ä¸¦æ¸…ç†ç¶²å€åˆ—
        sessionStorage.setItem('google_access_token', accessToken);
        history.replaceState(null, null, window.location.pathname); 
    }

    // 2. æª¢æŸ¥æ˜¯å¦æœ‰ Token
    if (sessionStorage.getItem('google_access_token')) {
        userStatusEl.innerHTML = 'âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨åŒæ­¥æ—¥æ›†...';
        signInButtonEl.style.display = 'none';
        render(true);
        return;
    }

    // 3. åˆå§‹åŒ– Google é‡æ–°å°å‘ç™»å…¥è¨­å®š
    window.google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: null, 
        flow: 'implicit',
        ux_mode: 'redirect', 
        redirect_uri: window.location.href, 
        scope: SCOPE
    });
    
    // 4. æ¸²æŸ“ç™»å…¥æŒ‰éˆ•
    userStatusEl.innerHTML = 'âš ï¸ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™»å…¥ Google é€²è¡ŒåŒæ­¥ã€‚';
    signInButtonEl.style.display = 'block';
    
    window.google.accounts.id.renderButton(
        signInButtonEl,
        { theme: 'outline', size: 'large' }
    );

    gisInited = true;
    render(false); 
}

function clearAll() {
    sessionStorage.removeItem('google_access_token');
    localStorage.removeItem(localStorageKey);
    location.reload();
}

// é»æ“Šæ™‚é–“æ§½çš„é‚è¼¯ (æ‰‹å‹•é ç´„)
function toggleSlot(theme, time, el) {
    if (el.classList.contains('blocked') || el.classList.contains('external-booked') || el.classList.contains('lobby-clash')) {
        return;
    }

    if (el.classList.contains('booked')) {
        localBookings[theme] = localBookings[theme].filter(t => t !== time);
        el.classList.remove('booked');
        el.classList.add('available');
    } else if (el.classList.contains('available')) {
        localBookings[theme].push(time);
        el.classList.remove('available');
        el.classList.add('booked');
    }
    
    localStorage.setItem(localStorageKey, JSON.stringify(localBookings));
    
    updateCombinedBookings();
    renderSlots();
    updateRemainingSlotsDisplay();
}

// è¨ˆç®—æ™‚é–“æ§½ç‹€æ…‹
function calculateSlotStatus(theme, timeStr) {
    const config = CONFIG[theme];
    const currentTime = tm(timeStr);
    const duration = config.dur;
    
    // 1. æª¢æŸ¥æ˜¯å¦è¢«å¤–éƒ¨æ—¥æ›†é ç´„
    if (externalBookings[theme] && externalBookings[theme].includes(timeStr)) {
        return 'external-booked';
    }

    // 2. æª¢æŸ¥æ˜¯å¦è¢«æ‰‹å‹•é ç´„
    if (localBookings[theme] && localBookings[theme].includes(timeStr)) {
        return 'booked';
    }

    // 3. æª¢æŸ¥æ˜¯å¦è¢«ä»»ä½•é ç´„é–å®š
    let isBlocked = false;
    let isLobbyClash = false;

    Object.keys(combinedBookings).forEach(otherTheme => {
        const otherConfig = CONFIG[otherTheme];
        
        combinedBookings[otherTheme].forEach(bookedTimeStr => {
            const bookedTime = tm(bookedTimeStr);
            const bookedDuration = otherConfig.dur;
            const blockBefore = otherConfig.block_before;
            const blockAfter = otherConfig.block_after;
            
            const lockStartTime = bookedTime - blockBefore;
            const lockEndTime = bookedTime + bookedDuration + blockAfter;

            const slotStartTime = currentTime;
            const slotEndTime = currentTime + duration;
            
            const overlap = Math.max(0, Math.min(slotEndTime, lockEndTime) - Math.max(slotStartTime, lockStartTime));

            if (overlap > 0) {
                if (theme === otherTheme) {
                    isBlocked = true;
                } else if (config.group === otherConfig.group) {
                    isLobbyClash = true;
                } else {
                    isBlocked = true;
                }
            }
        });
    });
    
    if (isLobbyClash) return 'lobby-clash';
    if (isBlocked) return 'blocked';
    
    // 4. å¯é ç´„
    return 'available';
}

function updateCombinedBookings() {
    combinedBookings = JSON.parse(JSON.stringify(localBookings));
    
    // åˆä½µå¤–éƒ¨æ—¥æ›†é ç´„
    Object.keys(externalBookings).forEach(theme => {
        externalBookings[theme].forEach(time => {
            if (!combinedBookings[theme].includes(time)) {
                combinedBookings[theme].push(time);
            }
        });
    });
}


function renderSlots() {
    Object.keys(CONFIG).forEach(theme => {
        const config = CONFIG[theme];
        const container = document.getElementById(config.id);
        const times = generateTimes(config.interval);
        
        let html = '';
        
        times.forEach(timeStr => {
            const status = calculateSlotStatus(theme, timeStr);
            let displayTime = timeStr;

            if (status === 'blocked') {
                displayTime = timeStr + '<br>(è¢«ä½”ç”¨)';
            } else if (status === 'lobby-clash') {
                displayTime = timeStr + '<br>(è¡çª)';
            } else if (status === 'external-booked') {
                displayTime = timeStr + '<br>(æ—¥æ›†å·²è¨‚)';
            }
            
            html += `<div class="slot ${status}" onclick="toggleSlot('${theme}', '${timeStr}', this)">${displayTime}</div>`;
        });
        
        container.innerHTML = html;
    });

    updateRemainingSlotsDisplay();
}

// è¼¸å‡ºå¯é ç´„æ™‚é–“
function updateRemainingSlotsDisplay() {
    Object.keys(CONFIG).forEach(theme => {
        const area = document.getElementById(`remaining-${theme}`);
        const config = CONFIG[theme];
        const times = generateTimes(config.interval);
        const availableSlots = [];

        times.forEach(timeStr => {
            if (calculateSlotStatus(theme, timeStr) === 'available') {
                availableSlots.push(timeStr);
            }
        });

        let slotsText = availableSlots.join(', ');
        if (slotsText.length > 200) {
            slotsText = availableSlots.slice(0, 15).join(', ') + '... (é»æ“Šè¤‡è£½æŸ¥çœ‹å…¨éƒ¨)';
        } else if (slotsText.length === 0) {
            slotsText = 'ä»Šæ—¥ç„¡ç©ºæª”';
        }

        const fullText = `${theme} å¯é ç´„æ™‚é–“ï¼š${availableSlots.join(', ')}`;
        
        area.innerHTML = `
            <strong>${theme} å¯é ç´„æ™‚é–“ (å…± ${availableSlots.length} æª”)ï¼š</strong>
            <div class="slot-text-container">${slotsText}</div>
            <button class="copy-button" onclick="copyToClipboard('${fullText}')">è¤‡è£½æ‰€æœ‰ç©ºæª”</button>
        `;
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert("å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nå…§å®¹ï¼š\n" + text);
    }).catch(err => {
        console.error('ç„¡æ³•è¤‡è£½æ–‡å­—: ', err);
        alert('ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
    });
}


async function fetchCalendarBookings(gasUrl) {
    const statusEl = document.getElementById('status-message');
    const token = sessionStorage.getItem('google_access_token');
    
    if (!token) {
        statusEl.innerHTML = 'âš ï¸ å°šæœªç™»å…¥ Googleã€‚ç„¡æ³•åŒæ­¥æ—¥æ›†ã€‚';
        statusEl.style.backgroundColor = '#f39c12';
        return {}; 
    }
    
    statusEl.innerHTML = 'ğŸ”„ æ­£åœ¨ä½¿ç”¨æ‚¨çš„æ†‘è­‰å‘æ—¥æ›†ä¼ºæœå™¨è«‹æ±‚è³‡æ–™...';
    statusEl.style.backgroundColor = '#3498db';

    try {
        // ****** ğŸš¨ é—œéµï¼šä½¿ç”¨ POST è«‹æ±‚ ğŸš¨ ******
        const response = await fetch(gasUrl, {
            method: 'POST', // å¼·åˆ¶ä½¿ç”¨ POST æ–¹æ³•
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ // å°‡ token æ”¾åœ¨è«‹æ±‚é«”ä¸­
                token: token
            })
        });
        
        // ç¢ºä¿éŸ¿æ‡‰ç‹€æ…‹ç¢¼åœ¨ 200-299 ç¯„åœå…§
        if (response.status === 405) {
            // å°ˆé–€è™•ç† Apps Script éƒ¨ç½²éŒ¯èª¤
             throw new Error(`GAS éƒ¨ç½²æ¬Šé™éŒ¯èª¤ (405)ã€‚è«‹æª¢æŸ¥éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­å®šç‚ºã€Œæ‰€æœ‰äººã€ã€‚`);
        }
        if (!response.ok) { 
          throw new Error(`ç¶²è·¯éŒ¯èª¤ ${response.status} (${response.statusText})`); 
        }
        
        const calendarEvents = await response.json();
        
        // æª¢æŸ¥ GAS è¿”å›çš„è‡ªè¨‚éŒ¯èª¤
        if (calendarEvents.error) {
            if (calendarEvents.error === "TOKEN_INVALID" || calendarEvents.error === "API_ERROR") {
                document.getElementById('user-status').innerHTML = 'âŒ ç™»å…¥æ†‘è­‰ç„¡æ•ˆæˆ–éæœŸï¼Œè«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€ï¼';
                sessionStorage.removeItem('google_access_token'); 
                statusEl.innerHTML = `è«‹é»æ“Šã€Œæ¸…ç©ºé‡ç½®ã€é‡æ–°é–‹å§‹ç™»å…¥ã€‚éŒ¯èª¤: ${calendarEvents.message}`;
                statusEl.style.backgroundColor = '#e74c3c';
                throw new Error("Auth/API Failed");
            }
            statusEl.innerHTML = `ğŸ›‘ GAS ç¨‹å¼ç¢¼åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤: ${calendarEvents.message || 'æœªçŸ¥'}`;
            statusEl.style.backgroundColor = '#e74c3c';
            throw new Error("EXECUTION_FAILED");
        }


        // æˆæ¬ŠæˆåŠŸ
        statusEl.innerHTML = 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼Œå·²åŒæ­¥æ‚¨çš„æ—¥æ›†äº‹ä»¶ã€‚';
        statusEl.style.backgroundColor = '#2ecc71';
        
        // è™•ç†äº‹ä»¶
        let tempExternalBookings = {};
        Object.keys(CONFIG).forEach(k => tempExternalBookings[k] = []);
        calendarEvents.forEach(event => {
            if (CONFIG[event.theme] && event.time) {
                tempExternalBookings[event.theme].push(event.time);
            }
        });
        return tempExternalBookings;


    } catch (error) {
        if (!["Auth/API Failed", "EXECUTION_FAILED"].includes(error.message)) {
             statusEl.innerHTML = `<p style="color:white; font-weight:bold; margin: 0;">âš ï¸ è¼‰å…¥æ—¥æ›†è³‡æ–™å¤±æ•—ï¼</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color:#ecf0f1;">éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
             statusEl.style.backgroundColor = '#95a5a6';
        }
        return {}; 
    }
}

async function render(shouldFetch = true) {
    if (shouldFetch) {
        externalBookings = await fetchCalendarBookings(GAS_URL);
    }
    
    updateCombinedBookings();
    renderSlots();
}

// ç¢ºä¿é¦–æ¬¡è¼‰å…¥æ™‚åˆå§‹åŒ– Google ç™»å…¥
window.onload = gisInit;
</script>
</body>
</html>